# å·¥ä½œæµä¸æ•°æ®å­˜å‚¨å‚è€ƒ

**æœ€åæ›´æ–°**: 2026-02-12  
**ç›®çš„**: å·¥ä½œæµè®¾è®¡ã€æ•°æ®æµè½¬ã€å­˜å‚¨ç»“æ„çš„å®Œæ•´å‚è€ƒ

---

## ğŸ“Š æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Frontend (React)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Import   â”‚â†’ â”‚ Script   â”‚â†’ â”‚ Novel    â”‚â†’ â”‚Alignment â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ HTTP/WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Backend API (FastAPI)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Workflows & Tools (Python)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Import         â”‚  â”‚ Script         â”‚  â”‚ Novel          â”‚    â”‚
â”‚  â”‚ Service        â”‚  â”‚ Analysis       â”‚  â”‚ Analysis       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ å†™å…¥/è¯»å–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Data Storage (JSON Files) - Phase I                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ raw/   â”‚â†’ â”‚ import/ â”‚â†’ â”‚script/novel  â”‚â†’ â”‚ alignment/ â”‚     â”‚
â”‚  â”‚        â”‚  â”‚         â”‚  â”‚  _analysis/  â”‚  â”‚            â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                     analyst/ (æ‰€æœ‰Phase Iæ•°æ®)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ ¸å¿ƒå·¥ä½œæµ

### Workflow 1: NovelProcessingWorkflow
**ç›®æ ‡**: ä»åŸå§‹å°è¯´åˆ°å®Œæ•´ç« èŠ‚åˆ†æ

**æ–‡ä»¶è·¯å¾„**: `src/workflows/novel_processing_workflow.py`

**å·¥å…·é“¾**:
```
Novel.txt 
    â†“ NovelImporter
è§„èŒƒåŒ–æ–‡æœ¬
    â†“ NovelMetadataExtractor
å…ƒæ•°æ® (metadata.json)
    â†“ NovelChapterDetector
ç« èŠ‚åˆ—è¡¨ (chapters.json)
    â†“ NovelSegmenter (å¹¶è¡Œå¤„ç†å„ç« èŠ‚)
åˆ†æ®µç»“æœ (segmented/chapter_*.json)
    â†“ NovelAnnotator (å¹¶è¡Œå¤„ç†å„ç« èŠ‚)
æ ‡æ³¨ç»“æœ (annotated/chapter_*.json)
    â†“ NovelSystemDetector (é€ç« å¤„ç†)
ç³»ç»Ÿç›®å½• (system_catalog.json)
    â†“ NovelValidator
è´¨é‡æŠ¥å‘Š
```

**è¾“å…¥å‚æ•°**:
```python
{
    "project_id": "project_001",
    "novel_path": "data/projects/project_001/raw/novel/novel.txt"
}
```

**è¾“å‡ºæ•°æ®**:
```
data/projects/project_001/analyst/
â”œâ”€â”€ import/novel/
â”‚   â”œâ”€â”€ novel-imported.md             # NovelImporterè¾“å‡º
â”‚   â”œâ”€â”€ metadata.json                 # NovelMetadataExtractorè¾“å‡º
â”‚   â”œâ”€â”€ chapters.json                 # NovelChapterDetectorè¾“å‡º
â”‚   â””â”€â”€ intro.md                      # å°è¯´ç®€ä»‹
â”‚
â””â”€â”€ novel_analysis/
    â”œâ”€â”€ chapter_001_segmentation_latest.json    # NovelSegmenterè¾“å‡º
    â”œâ”€â”€ chapter_001_annotation_latest.json      # NovelAnnotatorè¾“å‡º
    â”œâ”€â”€ system_catalog_latest.json              # NovelSystemDetectorè¾“å‡º
    â””â”€â”€ history/                                # å†å²ç‰ˆæœ¬
```

**æ‰§è¡Œé…ç½®**:
```python
NovelProcessingConfig(
    use_llm=True,
    llm_provider_segmentation="claude",     # åˆ†æ®µå¿…é¡»ç”¨Claude
    llm_provider_annotation="claude",       # æ ‡æ³¨å¿…é¡»ç”¨Claude
    llm_provider_system="claude",           # ç³»ç»Ÿæ£€æµ‹å¿…é¡»ç”¨Claude
    parallel_chapters=True,                 # å¹¶è¡Œå¤„ç†ç« èŠ‚
    max_workers=3                           # æœ€å¤§å¹¶å‘æ•°
)
```

**æˆæœ¬ä¼°ç®—**:
- åˆ†æ®µ: ~$0.06/ç«  (Two-Pass Claude)
- æ ‡æ³¨: ~$0.08/ç«  (Two-Pass Claude)
- ç³»ç»Ÿæ£€æµ‹: ~$0.02/ç«  (ç‹¬ç«‹Pass Claude)
- **æ€»è®¡**: ~$0.16/ç« ï¼Œ50ç« çº¦ $8

---

### Workflow 2: ScriptProcessingWorkflow
**ç›®æ ‡**: ä»SRTåˆ°ç»“æ„åŒ–è„šæœ¬åˆ†æ®µ

**æ–‡ä»¶è·¯å¾„**: `src/workflows/script_processing_workflow.py`

**å·¥å…·é“¾**:
```
SRTæ–‡ä»¶
    â†“ SrtImporter
SRTæ¡ç›®åˆ—è¡¨
    â†“ SrtTextExtractor
çº¯æ–‡æœ¬ + æ ‡ç‚¹ä¿®å¤
    â†“ HookDetector (ä»…ep01)
Hookä¿¡æ¯
    â†“ ScriptSegmenter (ABCåˆ†ç±»)
åˆ†æ®µç»“æœ
    â†“ ScriptValidator
è´¨é‡æŠ¥å‘Š
```

**è¾“å…¥å‚æ•°**:
```python
{
    "project_id": "project_001",
    "srt_files": [
        "data/projects/project_001/raw/script/ep01.srt",
        "data/projects/project_001/raw/script/ep02.srt"
    ]
}
```

**è¾“å‡ºæ•°æ®**:
```
data/projects/project_001/analyst/
â”œâ”€â”€ import/script/
â”‚   â”œâ”€â”€ episodes.json                 # é›†æ•°ç´¢å¼•
â”‚   â”œâ”€â”€ ep01.json                     # é›†æ•°å…ƒæ•°æ®
â”‚   â”œâ”€â”€ ep01-imported.md              # SrtTextExtractorè¾“å‡º
â”‚   â””â”€â”€ ep02-imported.md
â”‚
â””â”€â”€ script_analysis/
    â”œâ”€â”€ ep01_segmentation_latest.json # ScriptSegmenterè¾“å‡º
    â”œâ”€â”€ ep01_hook_latest.json         # HookDetectorè¾“å‡ºï¼ˆä»…ep01ï¼‰
    â””â”€â”€ history/                      # å†å²ç‰ˆæœ¬
```

**æ‰§è¡Œé…ç½®**:
```python
ScriptProcessingConfig(
    use_llm=True,
    llm_provider="deepseek",            # Scriptå¤„ç†ç”¨DeepSeek
    detect_hook_ep01=True,              # ä»…ep01æ£€æµ‹Hook
    parallel_episodes=True,             # å¹¶è¡Œå¤„ç†é›†æ•°
    max_workers=3
)
```

**æˆæœ¬ä¼°ç®—**:
- æ–‡æœ¬æå–: ~$0.02/é›† (DeepSeek)
- Hookæ£€æµ‹: ~$0.05 (ä»…ep01, Claude)
- åˆ†æ®µ: ~$0.03/é›† (DeepSeek)
- **æ€»è®¡**: ep01çº¦$0.10ï¼Œå…¶ä»–é›†çº¦$0.05/é›†

---

### Workflow 3: ImportService (åŸPreprocessService) â­
**ç›®æ ‡**: æ–‡ä»¶ä¸Šä¼ åè‡ªåŠ¨å¯¼å…¥ä¸æ ‡å‡†åŒ–ï¼ˆåå°å¼‚æ­¥ä»»åŠ¡ï¼‰

**æ–‡ä»¶è·¯å¾„**: `src/workflows/import_service.py`

**è§¦å‘æ–¹å¼**: æ–‡ä»¶ä¸Šä¼ åˆ°raw/åè‡ªåŠ¨è§¦å‘

**å¤„ç†æµç¨‹**:
```python
# ä¼ªä»£ç 
def auto_import(project_id, file_path):
    # 1. è¯†åˆ«æ–‡ä»¶ç±»å‹
    file_type = detect_file_type(file_path)  # .txt â†’ novel, .srt â†’ script
    
    # 2. æ ¹æ®ç±»å‹æ‰§è¡Œå¯¼å…¥ä¸æ ‡å‡†åŒ–
    if file_type == "novel":
        # å¯¼å…¥ â†’ å…ƒæ•°æ®æå– â†’ ç« èŠ‚æ£€æµ‹
        # è¾“å‡ºåˆ°: analyst/import/novel/
        NovelImporter.execute(...)
        NovelMetadataExtractor.execute(...)
        NovelChapterDetector.execute(...)
        
    elif file_type == "script":
        # å¯¼å…¥ â†’ æ–‡æœ¬æå–
        # è¾“å‡ºåˆ°: analyst/import/script/
        SrtImporter.execute(...)
        SrtTextExtractor.execute(...)
    
    # 3. æ›´æ–°é¡¹ç›®çŠ¶æ€
    update_workflow_stage(project_id, "import", "completed")
```

**çŠ¶æ€è¿½è¸ª**:
```json
{
  "project_id": "project_001",
  "preprocess_status": {
    "novel": {
      "status": "completed",
      "tasks": [
        {"name": "å¯¼å…¥", "status": "completed", "progress": 100},
        {"name": "å…ƒæ•°æ®æå–", "status": "completed", "progress": 100},
        {"name": "ç« èŠ‚æ£€æµ‹", "status": "completed", "progress": 100}
      ]
    },
    "script": {
      "status": "running",
      "tasks": [
        {"name": "ep01.srt å¯¼å…¥", "status": "completed", "progress": 100},
        {"name": "ep01.srt æ–‡æœ¬æå–", "status": "running", "progress": 45}
      ]
    }
  }
}
```

**APIé›†æˆ**:
```typescript
// å‰ç«¯è½®è¯¢æˆ–WebSocketè·å–çŠ¶æ€
const status = await fetch(`/api/v2/projects/${projectId}/preprocess-status`);
```

---

## ğŸ“ æ•°æ®å­˜å‚¨ç»“æ„

### ç›®å½•ç»“æ„ï¼ˆPhase I Analyst Workflowï¼‰

```
data/projects/{project_id}/
â”‚
â”œâ”€â”€ meta.json                          # é¡¹ç›®å…ƒæ•°æ®ï¼ˆåŒ…å«workflow_stagesï¼‰
â”‚
â”œâ”€â”€ raw/                               # åŸå§‹æ–‡ä»¶ï¼ˆç”¨æˆ·ä¸Šä¼ ï¼‰
â”‚   â”œâ”€â”€ novel/
â”‚   â”‚   â””â”€â”€ åºåˆ—å…¬è·¯æ±‚ç”Ÿ.txt
â”‚   â””â”€â”€ script/                        # âš ï¸ ä»srtæ”¹åä¸ºscript
â”‚       â”œâ”€â”€ ep01.srt
â”‚       â””â”€â”€ ep02.srt
â”‚
â””â”€â”€ analyst/                           # ğŸŒŸ Phase I æ‰€æœ‰åˆ†ææ•°æ®
    â”‚
    â”œâ”€â”€ import/                        # Step 1: å¯¼å…¥ä¸æ ‡å‡†åŒ–
    â”‚   â”œâ”€â”€ novel/
    â”‚   â”‚   â”œâ”€â”€ metadata.json          # å°è¯´å…ƒæ•°æ®
    â”‚   â”‚   â”œâ”€â”€ chapters.json          # ç« èŠ‚åˆ—è¡¨
    â”‚   â”‚   â”œâ”€â”€ intro.md               # å°è¯´ç®€ä»‹
    â”‚   â”‚   â””â”€â”€ novel-imported.md      # æ ‡å‡†åŒ–åçš„å®Œæ•´å°è¯´
    â”‚   â”‚
    â”‚   â””â”€â”€ script/
    â”‚       â”œâ”€â”€ episodes.json          # é›†æ•°ç´¢å¼•
    â”‚       â”œâ”€â”€ ep01.json              # é›†æ•°å…ƒæ•°æ®
    â”‚       â”œâ”€â”€ ep01-imported.md       # æ ‡å‡†åŒ–åçš„è„šæœ¬
    â”‚       â””â”€â”€ ep02-imported.md
    â”‚
    â”œâ”€â”€ script_analysis/               # Step 2: è„šæœ¬åˆ†æ
    â”‚   â”œâ”€â”€ ep01_segmentation_latest.json
    â”‚   â”œâ”€â”€ ep01_hook_latest.json      # ä»…ep01æœ‰Hook
    â”‚   â”œâ”€â”€ ep02_segmentation_latest.json
    â”‚   â””â”€â”€ history/                   # å†å²ç‰ˆæœ¬
    â”‚       â”œâ”€â”€ ep01_segmentation_v20260211_100000.json
    â”‚       â””â”€â”€ ...
    â”‚
    â”œâ”€â”€ novel_analysis/                # Step 3: å°è¯´åˆ†æ
    â”‚   â”œâ”€â”€ chapter_001_segmentation_latest.json
    â”‚   â”œâ”€â”€ chapter_001_annotation_latest.json
    â”‚   â”œâ”€â”€ chapter_002_segmentation_latest.json
    â”‚   â”œâ”€â”€ chapter_002_annotation_latest.json
    â”‚   â”œâ”€â”€ system_catalog_latest.json
    â”‚   â””â”€â”€ history/                   # å†å²ç‰ˆæœ¬
    â”‚       â”œâ”€â”€ chapter_001_segmentation_v20260211_100000.json
    â”‚       â””â”€â”€ ...
    â”‚
    â””â”€â”€ alignment/                     # Step 4: å¯¹é½åˆ†æ
        â”œâ”€â”€ chapter_001_ep01_alignment_latest.json
        â”œâ”€â”€ chapter_002_ep02_alignment_latest.json
        â””â”€â”€ history/                   # å†å²ç‰ˆæœ¬
            â”œâ”€â”€ chapter_001_ep01_alignment_v20260212_080000.json
            â””â”€â”€ ...
```

---

### é¡¹ç›®å…ƒæ•°æ® (meta.json)

**ä½ç½®**: `data/projects/{project_id}/meta.json`

**ç»“æ„**:
```json
{
  "project_id": "project_001",
  "name": "åºåˆ—å…¬è·¯æ±‚ç”Ÿ",
  "description": "æœ«æ—¥å‡çº§é¢˜æ",
  "created_at": "2026-02-10T10:00:00Z",
  "updated_at": "2026-02-12T08:30:00Z",
  "status": "completed",
  
  "sources": {
    "has_novel": true,
    "has_script": true,
    "novel_files": ["åºåˆ—å…¬è·¯æ±‚ç”Ÿ.txt"],
    "script_files": ["ep01.srt", "ep02.srt"],
    "novel_chapters": 50,
    "script_episodes": 5
  },
  
  "workflow_stages": {
    "import": {
      "status": "completed",
      "updated_at": "2026-02-10T10:30:00Z"
    },
    "metadata": {
      "status": "completed",
      "updated_at": "2026-02-10T11:00:00Z"
    },
    "segmentation": {
      "status": "completed",
      "novel_progress": 50,
      "novel_total": 50,
      "script_progress": 5,
      "script_total": 5,
      "updated_at": "2026-02-11T14:00:00Z"
    },
    "annotation": {
      "status": "running",
      "novel_progress": 30,
      "novel_total": 50,
      "updated_at": "2026-02-12T08:30:00Z"
    },
    "alignment": {
      "status": "pending"
    }
  }
}
```

**Schema**: `src/core/schemas_project.py::ProjectV2`

---

### ç« èŠ‚æ•°æ® (chapters.json)

**ä½ç½®**: `data/projects/{project_id}/analyst/import/novel/chapters.json`

**ç»“æ„**:
```json
[
  {
    "id": "chapter_001",
    "index": 1,
    "title": "ç¬¬ä¸€ç«  æœ«æ—¥é™ä¸´",
    "start_line": 1,
    "end_line": 150,
    "char_count": 3500,
    "has_segmentation": true,
    "has_annotation": true
  },
  {
    "id": "chapter_002",
    "index": 2,
    "title": "ç¬¬äºŒç«  ç³»ç»Ÿè§‰é†’",
    "start_line": 151,
    "end_line": 300,
    "char_count": 3200,
    "has_segmentation": true,
    "has_annotation": false
  }
]
```

**Schema**: `src/core/schemas_novel/basic.py::ChapterInfo`

---

### åˆ†æ®µç»“æœ (chapter_*_segmentation_latest.json)

**ä½ç½®**: `data/projects/{project_id}/analyst/novel_analysis/chapter_001_segmentation_latest.json`

**ç»“æ„**:
```json
{
  "chapter_id": "chapter_001",
  "chapter_title": "ç¬¬ä¸€ç«  æœ«æ—¥é™ä¸´",
  "segmentation_version": "v3_twopass",
  "llm_provider": "claude-sonnet-4-5",
  "created_at": "2026-02-11T10:00:00Z",
  
  "paragraphs": [
    {
      "id": "p001",
      "index": 1,
      "class_type": "B",
      "title": "æ”¶éŸ³æœºæ’­æŠ¥ä¸Šæ²ªæ²¦é™·",
      "content": "æ²ªå¸‚ç”µå°æ’­éŸ³å‘˜...",
      "start_line": 1,
      "end_line": 5,
      "char_count": 120,
      "functional_tags": ["æƒ…èŠ‚æ¨è¿›", "ä¸–ç•Œè§‚æ„å»º"]
    },
    {
      "id": "p002",
      "index": 2,
      "class_type": "A",
      "title": "è¯¡å¼‚çˆ†å‘èƒŒæ™¯è¯´æ˜",
      "content": "ä¸‰å¤©å‰ï¼Œå…¨çƒçˆ†å‘...",
      "start_line": 6,
      "end_line": 10,
      "char_count": 200,
      "functional_tags": ["ä¸–ç•Œè§‚æ„å»º", "èƒŒæ™¯é“ºå«"]
    }
  ],
  
  "stats": {
    "total_paragraphs": 11,
    "class_distribution": {
      "A": 3,
      "B": 7,
      "C": 1
    }
  }
}
```

**Schema**: `src/core/schemas_novel/segmentation.py::SegmentationResult`

---

### æ ‡æ³¨ç»“æœ (chapter_*_annotation_latest.json)

**ä½ç½®**: `data/projects/{project_id}/analyst/novel_analysis/chapter_001_annotation_latest.json`

**ç»“æ„**:
```json
{
  "chapter_id": "chapter_001",
  "segmentation_input": "chapter_001_v20260211_100000",
  "annotation_version": "v2_twopass",
  "llm_provider": "claude-sonnet-4-5",
  "created_at": "2026-02-11T12:00:00Z",
  
  "event_timeline": {
    "events": [
      {
        "id": "event_001",
        "event_summary": "ä¸»è§’å¬åˆ°æ”¶éŸ³æœºæ’­æŠ¥ï¼Œå¾—çŸ¥ä¸Šæ²ªæ²¦é™·",
        "event_type": "ä¿¡æ¯è·å–",
        "participants": ["ä¸»è§’"],
        "location": "å°å‡ºç§Ÿå±‹",
        "time_description": "æœ«æ—¥ç¬¬ä¸‰å¤©æ—©æ™¨",
        "source_paragraphs": ["p001", "p002"],
        "importance": "high"
      }
    ]
  },
  
  "setting_correlation": {
    "settings": [
      {
        "paragraph_id": "p002",
        "setting_type": "ä¸–ç•Œè§‚",
        "setting_content": "è¯¡å¼‚çˆ†å‘å¯¼è‡´äººç±»å˜å¼‚",
        "correlation_type": "BF",
        "related_events": ["event_001"]
      }
    ]
  },
  
  "knowledge_base": {
    "worldview": ["è¯¡å¼‚çˆ†å‘", "äººç±»å˜å¼‚"],
    "characters": ["ä¸»è§’-æ—é»˜"],
    "systems": ["ç”Ÿå­˜ç³»ç»Ÿ"]
  }
}
```

**Schema**: `src/core/schemas_novel/annotation.py::AnnotatedChapter`

---

### ç³»ç»Ÿç›®å½• (system_catalog_latest.json)

**ä½ç½®**: `data/projects/{project_id}/analyst/novel_analysis/system_catalog_latest.json`

**ç»“æ„**:
```json
{
  "project_id": "project_001",
  "version": "v1",
  "created_at": "2026-02-11T14:00:00Z",
  "updated_at": "2026-02-12T08:00:00Z",
  
  "categories": [
    {
      "id": "SC001",
      "name": "è§’è‰²ä¸ç”Ÿç‰©",
      "description": "ä¸»è§’ã€é…è§’ã€è¯¡å¼‚ç”Ÿç‰©",
      "elements": [
        {
          "id": "SC001-001",
          "name": "æ—é»˜",
          "type": "ä¸»è§’",
          "first_appearance": "chapter_001",
          "description": "æœ«æ—¥æ±‚ç”Ÿè€…ï¼Œæ‹¥æœ‰ç”Ÿå­˜ç³»ç»Ÿ"
        }
      ]
    },
    {
      "id": "SC002",
      "name": "ç‰©å“ä¸é“å…·",
      "description": "å…³é”®ç‰©å“ã€æ­¦å™¨ã€æ¶ˆè€—å“",
      "elements": [
        {
          "id": "SC002-001",
          "name": "æ”¹è£…å¼©ç®­",
          "type": "æ­¦å™¨",
          "first_appearance": "chapter_003",
          "description": "ä¸»è§’è‡ªåˆ¶çš„è¿œç¨‹æ­¦å™¨"
        }
      ]
    }
  ]
}
```

**Schema**: `src/core/schemas_novel/system.py::SystemCatalog`

---

## ğŸ”„ æ•°æ®æµè½¬ï¼ˆPhase I Analyst Workflowï¼‰

### Step 1: Import å¯¼å…¥ä¸æ ‡å‡†åŒ–

```
å¤–éƒ¨æ–‡ä»¶ä¸Šä¼ 
    â†“
raw/novel/novel.txt
raw/script/ep01.srt
    â†“ NovelImporter / SrtImporter
analyst/import/novel/novel-imported.md
analyst/import/script/ep01-imported.md
    â†“ NovelMetadataExtractor / NovelChapterDetector
analyst/import/novel/metadata.json
analyst/import/novel/chapters.json
analyst/import/script/episodes.json
```

### Step 2: Script Analysis è„šæœ¬åˆ†æ

```
analyst/import/script/ep01-imported.md (å–æ–‡ä»¶)
    â†“ ScriptSegmenter + HookDetector
analyst/script_analysis/ep01_segmentation_latest.json
analyst/script_analysis/ep01_hook_latest.json (ä»…ep01)
```

### Step 3: Novel Analysis å°è¯´åˆ†æ

```
analyst/import/novel/chapters.json (å–æ–‡ä»¶)
analyst/import/novel/novel-imported.md (å–æ–‡ä»¶)
    â†“ NovelSegmenter (å¹¶è¡Œå¤„ç†å„ç« èŠ‚)
analyst/novel_analysis/chapter_001_segmentation_latest.json
    â†“ NovelAnnotator (å¹¶è¡Œå¤„ç†å„ç« èŠ‚)
analyst/novel_analysis/chapter_001_annotation_latest.json
    â†“ NovelSystemDetector (é€ç« å¤„ç†)
analyst/novel_analysis/system_catalog_latest.json
```

### Step 4: Alignment å¯¹é½åˆ†æ

```
analyst/script_analysis/ep01_segmentation_latest.json (å–æ–‡ä»¶)
+
analyst/novel_analysis/chapter_001_annotation_latest.json (å–æ–‡ä»¶)
    â†“ NovelScriptAligner
analyst/alignment/chapter_001_ep01_alignment_latest.json
```

---

## ğŸ“ å‘½åè§„èŒƒ

### é¡¹ç›®ID
- æ ¼å¼: `project_{number}`
- ç¤ºä¾‹: `project_001`, `project_002`

### ç« èŠ‚ID
- æ ¼å¼: `chapter_{number}`
- ç¤ºä¾‹: `chapter_001`, `chapter_050`

### é›†æ•°ID
- æ ¼å¼: `ep{number}`
- ç¤ºä¾‹: `ep01`, `ep10`

### æ®µè½ID
- æ ¼å¼: `p{number}`
- ç¤ºä¾‹: `p001`, `p012`

### äº‹ä»¶ID
- æ ¼å¼: `event_{number}`
- ç¤ºä¾‹: `event_001`, `event_030`

### ç³»ç»Ÿå…ƒç´ ID
- æ ¼å¼: `{CategoryID}-{number}`
- ç¤ºä¾‹: `SC001-001`, `SC002-015`

---

## ğŸ¯ å·¥ä½œæµçŠ¶æ€ç®¡ç†

### çŠ¶æ€å€¼

| çŠ¶æ€ | è¯´æ˜ |
|------|------|
| `pending` | ç­‰å¾…æ‰§è¡Œ |
| `running` | æ‰§è¡Œä¸­ |
| `completed` | å·²å®Œæˆ |
| `failed` | æ‰§è¡Œå¤±è´¥ |
| `cancelled` | å·²å–æ¶ˆ |

### æ›´æ–°æœºåˆ¶

**åç«¯æ›´æ–°**:
```python
from src.core.project_manager_v2 import ProjectManagerV2
pm = ProjectManagerV2()

# æ›´æ–°å·¥ä½œæµçŠ¶æ€
pm.update_workflow_stage(
    project_id="project_001",
    stage="segmentation",
    status="running",
    metadata={
        "novel_progress": 10,
        "novel_total": 50
    }
)
```

**å‰ç«¯è½®è¯¢**:
```typescript
// æ¯2ç§’è½®è¯¢ä¸€æ¬¡
setInterval(async () => {
  const status = await fetch(`/api/v2/projects/${projectId}/preprocess-status`);
  updateUI(status);
}, 2000);
```

---

## ğŸ”§ é”™è¯¯æ¢å¤æœºåˆ¶

### è‡ªåŠ¨é‡è¯•

**é…ç½®**:
```python
RetryConfig(
    max_retries=3,
    retry_delay=5,  # ç§’
    exponential_backoff=True
)
```

**é‡è¯•ç­–ç•¥**:
- LLMè°ƒç”¨å¤±è´¥ â†’ è‡ªåŠ¨é‡è¯•3æ¬¡
- æ–‡ä»¶è¯»å–å¤±è´¥ â†’ ç«‹å³å¤±è´¥ï¼ˆä¸é‡è¯•ï¼‰
- ç½‘ç»œè¶…æ—¶ â†’ æŒ‡æ•°é€€é¿é‡è¯•

### æ–­ç‚¹ç»­ä¼ 

å·¥ä½œæµæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼š
```python
# æ£€æŸ¥å“ªäº›ç« èŠ‚å·²å¤„ç†
completed_chapters = get_completed_chapters(project_id)

# åªå¤„ç†æœªå®Œæˆçš„ç« èŠ‚
remaining_chapters = [ch for ch in all_chapters if ch not in completed_chapters]
```

---

## ğŸ“Š æˆæœ¬ä¼°ç®—

### Novelå¤„ç†æˆæœ¬ï¼ˆ50ç« ï¼‰

| æ­¥éª¤ | LLM | æˆæœ¬/ç«  | æ€»æˆæœ¬ |
|------|-----|---------|--------|
| å¯¼å…¥ | âŒ | $0 | $0 |
| å…ƒæ•°æ®æå– | DeepSeek | $0.01 | $0.50 |
| ç« èŠ‚æ£€æµ‹ | âŒ | $0 | $0 |
| åˆ†æ®µ | Claude | $0.06 | $3.00 |
| æ ‡æ³¨ | Claude | $0.08 | $4.00 |
| ç³»ç»Ÿæ£€æµ‹ | Claude | $0.02 | $1.00 |
| **æ€»è®¡** | - | **$0.17** | **$8.50** |

### Scriptå¤„ç†æˆæœ¬ï¼ˆ5é›†ï¼‰

| æ­¥éª¤ | LLM | æˆæœ¬/é›† | æ€»æˆæœ¬ |
|------|-----|---------|--------|
| å¯¼å…¥ | âŒ | $0 | $0 |
| æ–‡æœ¬æå– | DeepSeek | $0.02 | $0.10 |
| Hookæ£€æµ‹ | Claude | $0.05 | $0.05 (ä»…ep01) |
| åˆ†æ®µ | DeepSeek | $0.03 | $0.15 |
| **æ€»è®¡** | - | **$0.05** | **$0.30** |

### å®Œæ•´é¡¹ç›®æˆæœ¬

- Novel: $8.50
- Script: $0.30
- Alignment: ~$2.00
- **é¡¹ç›®æ€»æˆæœ¬**: ~$11

---

**ç»´æŠ¤è¯´æ˜**: 
- ä¿®æ”¹å·¥ä½œæµæ—¶ï¼Œè¯·åŒæ­¥æ›´æ–°æœ¬æ–‡æ¡£
- ä¿®æ”¹æ•°æ®ç»“æ„æ—¶ï¼Œè¯·æ›´æ–°å¯¹åº”Schemaè·¯å¾„
- æ–°å¢å·¥ä½œæµæ—¶ï¼Œè¯·æ·»åŠ å®Œæ•´è¯´æ˜

**æœ€åæ›´æ–°**: 2026-02-13  
**å·¥ä½œæµæ•°é‡**: 3ä¸ªæ ¸å¿ƒå·¥ä½œæµ  
**é‡å¤§å˜æ›´**: 
- æ•°æ®å­˜å‚¨ç»Ÿä¸€åˆ° `analyst/` ç›®å½•ä¸‹
- `raw/srt/` æ”¹åä¸º `raw/script/`
- å»é™¤ `processed/` å’Œé¡¶å±‚ `alignment/` æ–‡ä»¶å¤¹
- é‡‡ç”¨å››æ­¥å·¥ä½œæµ: import â†’ script_analysis â†’ novel_analysis â†’ alignment

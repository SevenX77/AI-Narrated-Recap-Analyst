# 系统追踪改进 - 存量追踪功能（2026-02-09）

## 📋 改进背景

用户反馈指出两个关键问题：
1. **缺少存量记录**：只有变化量（+300），没有存量（0→300→0）
2. **事件4的杀戮点流转不完整**：原文说"用所有的杀戮点升级自行车"，应该显示获得300 → 消耗300的完整流程

## ✅ 改进内容

### 1. **数据模型扩展**

在 `SystemChange` 中新增两个字段：

```python
class SystemChange(BaseModel):
    element_name: str
    category_id: str
    change_type: Literal["获得", "消耗", "升级", "遭遇", "状态变化"]
    change_description: str
    quantity_change: Optional[str]  # 已有字段：+300, -10
    quantity_before: Optional[str]  # ⚡ 新增：变化前存量
    quantity_after: Optional[str]   # ⚡ 新增：变化后存量
```

### 2. **Prompt更新**

#### **增加存量追踪规范**

```yaml
## 数量表示规范（重要！）⚠️

**核心原则：同时记录"变化量"和"存量"**

**数量变化（必填）**：
- 获得：`+50`
- 消耗：`-10`
- 升级：`1→2`

**存量追踪（重要！）**：
- 变化前存量：事件前的数量（如：`100`）
- 变化后存量：事件后的数量（如：`150`）
- 如果是首次获得：变化前=`0`，变化后=变化量
- 如果全部消耗：变化后=`0`

**示例**：
1. **首次获得300杀戮点**：
   - 数量变化：`+300`
   - 变化前存量：`0`
   - 变化后存量：`300`

2. **消耗300杀戮点（全部用完）**：
   - 数量变化：`-300`
   - 变化前存量：`300`
   - 变化后存量：`0`

3. **增加50积分（原有100）**：
   - 数量变化：`+50`
   - 变化前存量：`100`
   - 变化后存量：`150`
```

#### **输出格式要求**

```markdown
### 变化1
- **元素**: [元素名称]（[类别ID] - [类别名称]）
- **变化类型**: 获得/消耗/升级/遭遇/状态变化
- **变化描述**: [详细描述变化内容]
- **数量变化**: +50 / -10 / 1→2 / 未知
- **变化前存量**: 100 / 0 / 未知  ← ⚡ 新增
- **变化后存量**: 150 / 0 / 未知  ← ⚡ 新增
```

### 3. **解析逻辑更新**

在 `NovelSystemTracker._parse_tracking_result()` 中新增：

```python
# 匹配变化前存量
quantity_before_match = re.search(quantity_before_pattern, line_stripped)
if quantity_before_match:
    before_str = quantity_before_match.group(1).strip()
    if before_str not in ["未知", "null", "无"]:
        current_change["quantity_before"] = before_str

# 匹配变化后存量
quantity_after_match = re.search(quantity_after_pattern, line_stripped)
if quantity_after_match:
    after_str = quantity_after_match.group(1).strip()
    if after_str not in ["未知", "null", "无"]:
        current_change["quantity_after"] = after_str
```

### 4. **输出格式改进**

#### **表格视图**

新增"存量变化"列：

| 事件ID | 系统变化 | 元素 | 变化类型 | 数量变化 | 存量变化 | 变化描述 |
|--------|---------|------|---------|---------|---------|---------|
| 000100004C | ✅ 有 | 杀戮点数 | 获得 | `+300` | `0→300` | 系统借贷300点 |
|  |  | 杀戮点数 | 消耗 | `-300` | `300→0` | 用所有点升级 |
|  |  | 二八大杠 | 升级 | `-` | `Lv.1→升级中` | 消耗300点升级 |

#### **详细报告**

```markdown
#### 变化1: 杀戮点数

- **类别**: SC001
- **变化类型**: 获得
- **描述**: 系统借贷给陈野300杀戮点（期限一个月）
- **数量变化**: `+300`
- **存量变化**: `0` → `300`  ← ⚡ 新增

#### 变化2: 杀戮点数

- **类别**: SC001
- **变化类型**: 消耗
- **描述**: 使用所有杀戮点升级二八大杠
- **数量变化**: `-300`
- **存量变化**: `300` → `0`  ← ⚡ 新增
```

## 📊 改进效果对比

### **改进前**

```
事件4：陈野觉醒升级系统并升级自行车
- 杀戮点数：获得（+300）
- 二八大杠：升级
```

**问题**：
- ❌ 看不出杀戮点的最终存量
- ❌ 不清楚300点是否用完
- ❌ 无法追踪资源流转

### **改进后**

```
事件4：陈野觉醒升级系统并升级自行车
- 杀戮点数：获得（+300）[存量: 0→300]
- 杀戮点数：消耗（-300）[存量: 300→0]
- 二八大杠：升级 [状态: Lv.1→升级中]
```

**优势**：
- ✅ 清晰显示资源流转：0 → 300 → 0
- ✅ 符合原文"用所有的点数升级"
- ✅ 完整追踪每个系统元素的存量变化

## 🎯 核心价值

### 1. **完整的资源流转记录**
- 不仅记录"发生了什么"（+300）
- 还记录"结果是什么"（0→300→0）

### 2. **符合游戏系统分析需求**
- 类似游戏日志/账户明细
- 可以还原任意时刻的资源状态
- 便于分析主角的资源管理策略

### 3. **支持跨章节追踪**
- 第1章结束时：杀戮点=0，二八大杠=Lv.2（升级中）
- 第2章开始时：继承上一章的存量
- 可以构建完整的资源变化时间线

## 📝 使用示例

### **示例1：资源累积**

```
章节1：
  - 积分获得：+100（0→100）
  - 积分消耗：-30（100→70）

章节2：
  - 积分获得：+50（70→120）
  - 积分消耗：-20（120→100）
```

### **示例2：装备升级**

```
事件A：获得手弩（0→1）
事件B：升级手弩（Lv.1→Lv.2）
事件C：强化手弩（Lv.2→Lv.2+1）
```

### **示例3：借贷机制**

```
事件1：借贷300点（0→300，负债+300）
事件2：消耗300点（300→0，负债=300）
事件X：还款150点（负债300→150）
```

## 🚀 未来扩展

### 1. **负债追踪**
- 当前：杀戮点 0→300（借贷）
- 扩展：杀戮点 0→300，负债 0→300

### 2. **多资源联动**
- 升级消耗：杀戮点-300，二八大杠Lv.1→Lv.2
- 兑换：积分-100，食物+10

### 3. **跨章节汇总**
- 第1-10章杀戮点总获得：+5000
- 第1-10章杀戮点总消耗：-4800
- 当前存量：200

## 📁 相关文件

- 数据模型：`src/core/schemas_novel.py` (SystemChange)
- Prompt：`src/prompts/novel_system_tracking.yaml`
- 工具：`src/tools/novel_system_tracker.py`
- 测试：`scripts/test/test_novel_system_tracker.py`

---

**更新日期**：2026-02-09  
**版本**：v2.0（存量追踪版）

# å¼€å‘è§„èŒƒä¸æ¶æ„æ–‡æ¡£ (Development Standards & Architecture)

## 0. æœ€é«˜ä¼˜å…ˆçº§ï¼šæ–‡æ¡£åŒæ­¥ (Documentation Sync - HIGHEST PRIORITY)

**ä»»ä½•ä»£ç å˜æ›´å¿…é¡»é¦–å…ˆä½“ç°åœ¨æ–‡æ¡£ä¸­ã€‚**

- **ä»£ç å³æ–‡æ¡£**: æ ¸å¿ƒé€»è¾‘å˜æ›´å¿…é¡»åŒæ­¥æ›´æ–° `docs/architecture/` ä¸‹çš„å¯¹åº”æ–‡æ¡£ã€‚
- **å¼ºåˆ¶æ£€æŸ¥**: è‡ªåŠ¨åŒ–è„šæœ¬ä¼šæ£€æŸ¥æ–‡æ¡£çš„æ›´æ–°æ—¶é—´ã€‚å¦‚æœä»£ç æ›´æ–°äº†ä½†æ–‡æ¡£æ²¡æ›´æ–°ï¼ŒCI/CD å°†ä¼šå¤±è´¥ã€‚
- **Docstrings**: æ‰€æœ‰ Public Class å’Œ Function å¿…é¡»åŒ…å« Google Style Docstringsã€‚
- **æ¶æ„å›¾**: å¤æ‚é€»è¾‘éœ€åœ¨æ–‡æ¡£ä¸­é€šè¿‡ Mermaid æˆ–æ–‡å­—æè¿°æ¸…æ¥šæ•°æ®æµå‘ã€‚

## 1. æ ¸å¿ƒåŸåˆ™ (Core Principles)

1.  **æ¨¡å—åŒ– (Modularity)**: 
    - ç³»ç»Ÿç”± **Tools (å·¥å…·)**, **Agents (æ™ºèƒ½ä½“)**, å’Œ **Workflows (å·¥ä½œæµ)** ç»„æˆã€‚
    - **Tools** å¿…é¡»æ˜¯æ— çŠ¶æ€ã€ç‹¬ç«‹çš„åŸå­æ“ä½œï¼ˆå¦‚ï¼šä¸‹è½½æ–‡ä»¶ã€åˆ‡å‰²æ–‡æœ¬ï¼‰ã€‚
    - **Agents** æ˜¯æœ‰çŠ¶æ€çš„ï¼Œè´Ÿè´£è°ƒç”¨ LLM è¿›è¡Œå†³ç­–æˆ–å¤„ç†ï¼Œå¹¶å¯ä»¥è°ƒç”¨ Toolsã€‚
    - **Workflows** æ˜¯ä¸šåŠ¡é€»è¾‘çš„ç¼–æ’è€…ï¼Œè´Ÿè´£ä¸²è” Agents å’Œ Toolsã€‚
    - ç¦æ­¢å¾ªç¯ä¾èµ–ã€‚

2.  **èŒè´£åˆ†ç¦» (Separation of Concerns)**:
    - **Analyst (åˆ†æå¸ˆ)**: å”¯ä¸€èŒè´£æ˜¯ **"ç†è§£" (Understanding)**ã€‚
        - è¾“å…¥: æ–‡æœ¬ (å°è¯´æˆ–è§£è¯´)ã€‚
        - è¾“å‡º: ç»“æ„åŒ–æ•°æ® (Events, Characters)ã€‚
        - **ç¦æ­¢**: Analyst ä¸åº”çŸ¥é“ "Script" æˆ– "Alignment" çš„å­˜åœ¨ã€‚
    - **Alignment (å¯¹é½å¼•æ“)**: å”¯ä¸€èŒè´£æ˜¯ **"æ˜ å°„" (Mapping)**ã€‚
        - è¾“å…¥: ä¸¤ç»„ç»“æ„åŒ–æ•°æ® (Novel Events, Script Events)ã€‚
        - è¾“å‡º: å®ƒä»¬ä¹‹é—´çš„å…³ç³» (Range/Mapping)ã€‚
        - **ç¦æ­¢**: Alignment ä¸åº”ç›´æ¥è¯»å–åŸå§‹å°è¯´æ–‡æœ¬è¿›è¡Œåˆ†æï¼Œåªå¤„ç†ç»“æ„åŒ–æ•°æ®ã€‚

## 2. ç›®å½•ç»“æ„ (Directory Structure)

```text
src/
â”œâ”€â”€ core/           # æ ¸å¿ƒæŠ½è±¡å±‚ (Base Classes, Interfaces, Config, Schemas)
â”œâ”€â”€ tools/          # ç‹¬ç«‹å·¥å…·åº“ (Stateless, Reusable)
â”œâ”€â”€ agents/         # æ™ºèƒ½ä½“å®ç° (Stateful, LLM-driven)
â”œâ”€â”€ workflows/      # ä¸šåŠ¡æµç¨‹ç¼–æ’ (Orchestration)
â”œâ”€â”€ modules/        # ä¸šåŠ¡é€»è¾‘æ¨¡å— (Alignment, etc.)
â”œâ”€â”€ utils/          # é€šç”¨è¾…åŠ©å‡½æ•° (Logging, Config)
â”œâ”€â”€ prompts/        # Prompt æ¨¡æ¿ (YAML/JSON)
â””â”€â”€ main.py         # å…¥å£æ–‡ä»¶
docs/
â”œâ”€â”€ architecture/   # æ¶æ„è®¾è®¡ä¸é€»è¾‘æ–‡æ¡£ (å¿…é¡»ä¸ä»£ç åŒæ­¥)
â”œâ”€â”€ maintenance/    # ç»´æŠ¤æ€§æ–‡æ¡£ (æ¸…ç†æŠ¥å‘Šã€å˜æ›´è®°å½•ã€è¿ç§»æ—¥å¿—)
â””â”€â”€ api/            # è‡ªåŠ¨ç”Ÿæˆçš„ API æ–‡æ¡£ (å¯é€‰)
root/
â”œâ”€â”€ data/           # é¡¹ç›®æ•°æ®å­˜å‚¨ (Projects, Raw Data, Artifacts)
â”œâ”€â”€ output/         # ç³»ç»Ÿè¾“å‡º (Logs, Operation History)
â”œâ”€â”€ logs/           # è¿è¡Œæ—¥å¿— (Deprecated, moved to output/)
â””â”€â”€ scripts/        # è¿ç»´è„šæœ¬ (Validation, Migration)
```

### ğŸ“ æ–‡æ¡£ç®¡ç†è§„èŒƒ

**ä¿æŒæ ¹ç›®å½•ç®€æ´æ˜¯å¼ºåˆ¶è¦æ±‚ï¼**

| æ–‡æ¡£ç±»å‹ | å¿…é¡»æ”¾ç½®ä½ç½® | ç¤ºä¾‹ | è¯´æ˜ |
|---------|------------|------|------|
| æ ¸å¿ƒæ–‡æ¡£ | `docs/` | DEV_STANDARDS.md, PROJECT_STRUCTURE.md | æ°¸ä¹…æ€§ã€å…¨å±€æ€§çš„æ–‡æ¡£ |
| æ¶æ„è®¾è®¡ | `docs/architecture/` | logic_flows.md | ç³»ç»Ÿæ¶æ„å’Œè®¾è®¡æ–‡æ¡£ |
| åŠŸèƒ½ä¼˜åŒ– | `docs/maintenance/` | ingestion_optimization_*.md | é’ˆå¯¹ç‰¹å®šåŠŸèƒ½çš„ä¼˜åŒ–/éƒ¨ç½²æ–‡æ¡£ |
| ç»´æŠ¤è®°å½• | `docs/maintenance/` | CLEANUP_SUMMARY.md | æ¸…ç†æŠ¥å‘Šã€å˜æ›´æ—¥å¿—ã€è¿ç§»è®°å½• |
| ç¤ºä¾‹è„šæœ¬ | `scripts/examples/` | generate_ep01_recap.py | ä½¿ç”¨ç¤ºä¾‹ä»£ç  |

**âŒ ä¸¥æ ¼ç¦æ­¢**ï¼š
- åœ¨ `docs/` æ ¹ç›®å½•åˆ›å»ºé’ˆå¯¹ç‰¹å®šåŠŸèƒ½çš„æ–‡æ¡£ï¼ˆåº”æ”¾åœ¨ `maintenance/` ä¸‹ï¼‰
- åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä»»ä½• `.md` æˆ– `.txt` æ–‡æ¡£æ–‡ä»¶
- åœ¨æ ¹ç›®å½•åˆ›å»ºä¸´æ—¶æµ‹è¯•æ–‡ä»¶

## 3. æ¨¡å—å®šä¹‰è§„èŒƒ (Module Specifications)

### 3.1 Tools (å·¥å…·)
- ç»§æ‰¿è‡ª `src.core.interfaces.BaseTool`ã€‚
- å¿…é¡»å®ç° `execute` æ–¹æ³•ã€‚
- è¾“å…¥è¾“å‡ºå¿…é¡»å¼ºç±»å‹ (Type Hinting)ã€‚
- **ç¦æ­¢** åœ¨ Tool å†…éƒ¨ç›´æ¥è°ƒç”¨ Agentã€‚

### 3.2 Agents (æ™ºèƒ½ä½“)
- ç»§æ‰¿è‡ª `src.core.interfaces.BaseAgent`ã€‚
- æ‹¥æœ‰ `context` (ä¸Šä¸‹æ–‡)ã€‚
- é€šè¿‡ `process` æ–¹æ³•å¤„ç†ä»»åŠ¡ã€‚

### 3.3 Workflows (å·¥ä½œæµ)
- ç»§æ‰¿è‡ª `src.core.interfaces.BaseWorkflow`ã€‚
- å®šä¹‰æ˜ç¡®çš„ `steps` (æ­¥éª¤)ã€‚
- è´Ÿè´£é”™è¯¯å¤„ç†å’Œå…¨å±€çŠ¶æ€ç®¡ç†ã€‚

### 3.4 Modules (ä¸šåŠ¡æ¨¡å—)
- å­˜æ”¾äº `src/modules/`ã€‚
- è´Ÿè´£ç‰¹å®šçš„ä¸šåŠ¡é€»è¾‘æˆ–ç®—æ³•å®ç°ï¼ˆå¦‚ Alignment, Ingestionï¼‰ã€‚
- å¯ä»¥åŒ…å«å¤æ‚çš„é€»è¾‘ï¼Œä½†ä¸åº”åƒ Agent é‚£æ ·å…·æœ‰è‡ªä¸»å†³ç­–æ€§ã€‚
- åº”å°½é‡ä¿æŒæ— çŠ¶æ€æˆ–ä»…ä¾èµ–è¾“å…¥æ•°æ®ã€‚
- å¿…é¡»å®šä¹‰æ¸…æ™°çš„è¾“å…¥è¾“å‡º Schemaã€‚

### 3.5 Core (æ ¸å¿ƒå±‚)
- å­˜æ”¾äº `src/core/`ã€‚
- ä»…åŒ…å«ï¼š
    - **Interfaces**: æŠ½è±¡åŸºç±» (Base Classes)ã€‚
    - **Config**: é…ç½®å®šä¹‰ä¸åŠ è½½ã€‚
    - **Schemas**: Pydantic æ•°æ®æ¨¡å‹ã€‚
- **ç¦æ­¢** åŒ…å«å…·ä½“çš„ä¸šåŠ¡é€»è¾‘å®ç°ã€‚

### 3.6 Utils (å·¥å…·åº“)
- å­˜æ”¾äº `src/utils/`ã€‚
- å¿…é¡»æ˜¯çº¯å‡½æ•° (Pure Functions) æˆ–é€šç”¨ Helper ç±»ã€‚
- **ç¦æ­¢** åŒ…å«ä¸šåŠ¡çŠ¶æ€æˆ–ç‰¹å®šä¸šåŠ¡é€»è¾‘ã€‚
- **ç¦æ­¢** å¾ªç¯ä¾èµ– Core æˆ– Modulesã€‚

## 4. å·¥ä½œæµä¸é€»è¾‘åŒæ­¥ (Workflow & Logic Sync)

ä»»ä½•æ—¶å€™ä¿®æ”¹ `src/workflows` æˆ–æ ¸å¿ƒç®—æ³•æ—¶ï¼Œå¿…é¡»åŒæ­¥æ›´æ–° `docs/architecture/logic_flows.md`ã€‚

## 5. é…ç½®ä¸å¯†é’¥ç®¡ç† (Configuration & Secrets)

- **å•ä¸€æ•°æ®æº**: æ‰€æœ‰é…ç½®ï¼ˆAPI Keys, Model Names, Pathsï¼‰å¿…é¡»é€šè¿‡ `src/core/config.py` ç»Ÿä¸€ç®¡ç†ï¼Œç¦æ­¢åœ¨ä¸šåŠ¡ä»£ç ä¸­ç¡¬ç¼–ç é»˜è®¤å€¼ã€‚
- **ç¯å¢ƒå˜é‡**: æ•æ„Ÿä¿¡æ¯å¿…é¡»é€šè¿‡ `.env` æ–‡ä»¶åŠ è½½ï¼Œä½¿ç”¨ `pydantic-settings` æˆ– `os.environ` è¯»å–ã€‚
- **ç¦æ­¢æäº¤**: `.env` æ–‡ä»¶å¿…é¡»åŒ…å«åœ¨ `.gitignore` ä¸­ã€‚

## 6. Prompt å·¥ç¨‹è§„èŒƒ (Prompt Engineering)

- **Prompt åˆ†ç¦»**: ç¦æ­¢å°†é•¿ Prompt å­—ç¬¦ä¸²ç¡¬ç¼–ç åœ¨ Python å‡½æ•°å†…éƒ¨ã€‚
- **å­˜å‚¨ä½ç½®**: å°† Prompt æå–åˆ° `src/prompts/` ç›®å½•ä¸‹çš„ YAML/JSON æ–‡ä»¶ä¸­ã€‚
- **ç‰ˆæœ¬æ§åˆ¶**: Prompt çš„å˜æ›´åº”è§†ä¸ºä»£ç å˜æ›´ï¼Œéœ€è¿›è¡Œç‰ˆæœ¬ç®¡ç†ã€‚

## 7. é”™è¯¯å¤„ç†ä¸æ—¥å¿— (Error Handling & Logging)

- **ç¦æ­¢ Print**: ç”Ÿäº§ç¯å¢ƒä»£ç ç¦æ­¢ä½¿ç”¨ `print()`ï¼Œå¿…é¡»ä½¿ç”¨ `logging` æ¨¡å—ã€‚
- **ç»“æ„åŒ–æ—¥å¿—**: æ—¥å¿—åº”åŒ…å« `timestamp`, `module`, `level`, `message`ã€‚
- **æ“ä½œæ—¥å¿— (Operation Log)**:
    - å…³é”®çš„æ–‡ä»¶ç”Ÿæˆæ“ä½œå¿…é¡»è®°å½•åˆ° `output/operation_history.jsonl`ã€‚
    - æ ¼å¼: `[Time] [ProjectID] [Action] -> [Output File]`ã€‚
- **é‡è¯•æœºåˆ¶**: å¯¹äº LLM è°ƒç”¨å’Œç½‘ç»œè¯·æ±‚ï¼Œå¿…é¡»å®ç°æŒ‡æ•°é€€é¿ (Exponential Backoff) çš„é‡è¯•æœºåˆ¶ã€‚

## 8. æ•°æ®å¥‘çº¦ (Data Contracts)

- **Schema å®šä¹‰**: æ¨¡å—é—´ä¼ é€’çš„æ•°æ®ç»“æ„ï¼ˆå¦‚ `SceneAnalysis`, `NarrativeEvent`ï¼‰åº”å®šä¹‰ä¸º Pydantic Modelsã€‚
- **ç»Ÿä¸€ä½ç½®**: ç»Ÿä¸€æ”¾ç½®åœ¨ `src/core/schemas.py` ä¸­ï¼Œç¦æ­¢æ•£è½åœ¨å„ä¸ª Agent æ–‡ä»¶é‡Œã€‚

---
*Last Updated: 2026-02-03*

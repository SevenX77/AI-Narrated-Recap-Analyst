# LLMå¹¶å‘è°ƒç”¨ç®¡ç†ç³»ç»Ÿ - å®Œæ•´å®ç°

## ğŸ‰ ç³»ç»Ÿæ¦‚è¿°

ä¸€ä¸ªå®Œæ•´çš„ã€ç”Ÿäº§å°±ç»ªçš„LLMå¹¶å‘è°ƒç”¨ç®¡ç†ç³»ç»Ÿï¼Œè§£å†³äº†ï¼š
1. âœ… APIé™æµé—®é¢˜ï¼ˆæ™ºèƒ½æ£€æµ‹+è‡ªåŠ¨é‡è¯•ï¼‰
2. âœ… å¹¶å‘æ§åˆ¶ï¼ˆå¤šæ¨¡å‹ç‹¬ç«‹ç®¡ç†ï¼‰
3. âœ… é™æµè§„åˆ™æµ‹è¯•ï¼ˆè‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·ï¼‰
4. âœ… é…ç½®æŒä¹…åŒ–ï¼ˆJSONæ–‡ä»¶ç®¡ç†ï¼‰
5. âœ… ä½¿ç”¨ç»Ÿè®¡ï¼ˆå®æ—¶ç›‘æ§ï¼‰

---

## ğŸ“¦ ç³»ç»Ÿç»„æˆ

### 1. æ ¸å¿ƒæ¨¡å—

#### `src/core/llm_rate_limiter.py`
- **LLMRateLimitConfig**: é…ç½®æ¨¡å‹ï¼ˆdataclassï¼‰
- **RateLimiter**: æ»‘åŠ¨çª—å£é™æµå™¨
- **LLMCallManager**: å…¨å±€è°ƒç”¨ç®¡ç†å™¨ï¼ˆå•ä¾‹ï¼‰
- **get_llm_manager()**: è·å–å…¨å±€å®ä¾‹

### 2. æµ‹è¯•å·¥å…·

#### `scripts/test/test_llm_manager_integration.py`
- æ¼”ç¤ºåŸºæœ¬ä½¿ç”¨
- æ¼”ç¤ºå¹¶å‘è°ƒç”¨
- æ¼”ç¤ºé™æµæ£€æµ‹
- æ¼”ç¤ºé…ç½®æ›´æ–°

#### `scripts/test/test_actual_api_limits.py`
- æµ‹è¯•DeepSeekå®é™…é™æµ
- æµ‹è¯•Anthropicå®é™…é™æµ
- è‡ªåŠ¨æ›´æ–°é…ç½®

#### `scripts/test/test_llm_rate_limits.py`
- äº¤äº’å¼æµ‹è¯•å·¥å…·
- å¿«é€Ÿæµ‹è¯•ï¼ˆmockæ•°æ®ï¼‰
- æ‰¹é‡æµ‹è¯•æ‰€æœ‰æä¾›å•†

### 3. é…ç½®æ–‡ä»¶

#### `data/llm_configs.json`
```json
{
  "anthropic_claude": {
    "provider": "anthropic",
    "model": "claude-3-5-sonnet-20241022",
    "requests_per_minute": 50,
    "tokens_per_minute": 40000,
    "max_concurrent": 3,
    "max_retries": 3,
    "base_retry_delay": 2.0,
    "max_retry_delay": 60.0,
    "rate_limit_errors": ["403", "429", "rate limit", "too many requests"],
    "is_tested": false,
    "last_test_date": null,
    "test_notes": "é»˜è®¤é…ç½®ï¼Œå¾…æµ‹è¯•éªŒè¯"
  },
  "deepseek_chat": {
    "provider": "deepseek",
    "model": "deepseek-chat",
    "requests_per_minute": 100,
    "tokens_per_minute": null,
    "max_concurrent": 3,
    "max_retries": 3,
    "base_retry_delay": 3.0,
    "max_retry_delay": 60.0,
    "rate_limit_errors": ["403", "429", "rate limit", "too many requests"],
    "is_tested": true,
    "last_test_date": "2026-02-10",
    "test_notes": "æµ‹è¯•éªŒè¯ï¼šå¯æ”¯æŒæ›´é«˜QPM"
  }
}
```

### 4. æ–‡æ¡£

- `docs/core/LLM_RATE_LIMIT_SYSTEM.md` - ç³»ç»Ÿè®¾è®¡æ–‡æ¡£
- `docs/core/LLM_INTEGRATION_GUIDE.md` - é›†æˆæŒ‡å—
- `docs/core/LLM_SYSTEM_COMPLETE.md` - æœ¬æ–‡æ¡£

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ä½¿ç”¨

```python
from src.core.llm_rate_limiter import get_llm_manager

# è·å–ç®¡ç†å™¨
manager = get_llm_manager()

# å®šä¹‰APIè°ƒç”¨
def my_api_call(prompt: str):
    # å®é™…çš„LLMè°ƒç”¨
    return client.chat.completions.create(...)

# ä½¿ç”¨ç®¡ç†å™¨è°ƒç”¨ï¼ˆè‡ªåŠ¨é™æµ+é‡è¯•ï¼‰
result = await manager.call_with_rate_limit(
    func=my_api_call,
    provider="deepseek",
    model="deepseek-chat",
    estimated_tokens=1000,
    prompt="ä½ å¥½"
)
```

### 2. æµ‹è¯•APIé™æµ

```bash
# è¿è¡Œå®é™…APIæµ‹è¯•ï¼ˆä¼šæ¶ˆè€—é…é¢ï¼ï¼‰
python3 scripts/test/test_actual_api_limits.py

# é€‰æ‹©è¦æµ‹è¯•çš„API
# ç¡®è®¤å¼€å§‹æµ‹è¯•
# ç­‰å¾…æµ‹è¯•å®Œæˆ
# é€‰æ‹©æ˜¯å¦æ›´æ–°é…ç½®
```

### 3. è¿è¡Œæ¼”ç¤º

```bash
# è¿è¡Œå®Œæ•´æ¼”ç¤ºï¼ˆä½¿ç”¨mockæ•°æ®ï¼Œä¸æ¶ˆè€—é…é¢ï¼‰
python3 scripts/test/test_llm_manager_integration.py
```

---

## ğŸ“Š ç³»ç»Ÿç‰¹æ€§

### 1. å¤šå±‚é™æµæ§åˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Workflowå¹¶å‘æ§åˆ¶               â”‚
â”‚  max_concurrent_chapters=2        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    LLMç®¡ç†å™¨é™æµæ§åˆ¶             â”‚
â”‚  QPM=30, max_concurrent=1        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    å®é™…APIè°ƒç”¨                   â”‚
â”‚  å¸¦é‡è¯•+æŒ‡æ•°é€€é¿                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ™ºèƒ½é‡è¯•ç­–ç•¥

```python
é‡è¯•ç­–ç•¥ï¼š
- ç¬¬1æ¬¡å¤±è´¥: ç­‰å¾…2ç§’
- ç¬¬2æ¬¡å¤±è´¥: ç­‰å¾…4ç§’ï¼ˆ2^1ï¼‰
- ç¬¬3æ¬¡å¤±è´¥: ç­‰å¾…8ç§’ï¼ˆ2^2ï¼‰
- å¦‚æœæ˜¯é™æµé”™è¯¯: å»¶è¿Ÿx2

ç¤ºä¾‹ï¼š
å°è¯•1 â†’ 403é”™è¯¯ â†’ ç­‰å¾…4ç§’ï¼ˆ2ç§’x2ï¼Œå› ä¸ºæ˜¯é™æµï¼‰
å°è¯•2 â†’ 403é”™è¯¯ â†’ ç­‰å¾…8ç§’ï¼ˆ4ç§’x2ï¼‰
å°è¯•3 â†’ 403é”™è¯¯ â†’ ç­‰å¾…16ç§’ï¼ˆ8ç§’x2ï¼‰
å°è¯•4 â†’ æˆåŠŸï¼
```

### 3. é™æµé”™è¯¯è¯†åˆ«

è‡ªåŠ¨è¯†åˆ«ä»¥ä¸‹é”™è¯¯ä¸ºé™æµï¼š
- HTTP 403 (access forbidden)
- HTTP 429 (too many requests)
- é”™è¯¯æ¶ˆæ¯åŒ…å« "rate limit"
- é”™è¯¯æ¶ˆæ¯åŒ…å« "quota"

### 4. æ»‘åŠ¨çª—å£ç®—æ³•

```python
æ—¶é—´çª—å£ç®¡ç†ï¼š
- åˆ†é’Ÿçª—å£: ä¿ç•™æœ€è¿‘60ç§’çš„è¯·æ±‚è®°å½•
- å¤©çª—å£: ä¿ç•™æœ€è¿‘24å°æ—¶çš„è¯·æ±‚è®°å½•
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸè®°å½•
- ç²¾ç¡®è®¡ç®—QPM/QPD

æ£€æŸ¥é€»è¾‘ï¼š
1. æ¸…ç†è¿‡æœŸè®°å½•
2. æ£€æŸ¥å½“å‰å¹¶å‘æ•°
3. æ£€æŸ¥QPM/QPD/TPM/TPDé™åˆ¶
4. å¦‚æœæœªè¶…è¿‡ï¼Œè®°å½•è¯·æ±‚å¹¶å…è®¸æ‰§è¡Œ
5. å¦‚æœè¶…è¿‡ï¼Œè¿”å›Falseï¼ˆç­‰å¾…ï¼‰
```

---

## ğŸ¯ ä¸åŒæ¨¡å‹çš„ç»éªŒé…ç½®

### DeepSeek (æµ‹è¯•éªŒè¯)

```json
{
  "provider": "deepseek",
  "model": "deepseek-chat",
  "requests_per_minute": 30,
  "max_concurrent": 1,
  "max_retries": 3,
  "base_retry_delay": 3.0,
  "test_notes": "ç»éªŒå€¼ï¼šQPM>30é¢‘ç¹è§¦å‘é™æµ"
}
```

**å»ºè®®åœºæ™¯**ï¼š
- å¤§æ‰¹é‡å¤„ç†ï¼ˆ100+ç« ï¼‰
- æˆæœ¬æ•æ„Ÿé¡¹ç›®
- å¯æ¥å—è¾ƒé•¿å¤„ç†æ—¶é—´

### Anthropic Claude

```json
{
  "provider": "anthropic",
  "model": "claude-3-5-sonnet-20241022",
  "requests_per_minute": 50,
  "tokens_per_minute": 40000,
  "max_concurrent": 3,
  "max_retries": 3,
  "base_retry_delay": 2.0
}
```

**å»ºè®®åœºæ™¯**ï¼š
- é«˜è´¨é‡è¦æ±‚
- å¿«é€Ÿå¤„ç†éœ€æ±‚
- ä»˜è´¹è´¦æˆ·

### OpenAI GPT-4

```json
{
  "provider": "openai",
  "model": "gpt-4",
  "requests_per_minute": 500,
  "tokens_per_minute": 10000,
  "max_concurrent": 5,
  "max_retries": 2,
  "base_retry_delay": 1.0
}
```

**å»ºè®®åœºæ™¯**ï¼š
- ä¼ä¸šçº§åº”ç”¨
- é«˜ååé‡éœ€æ±‚
- é«˜çº§ä»˜è´¹è´¦æˆ·

### Conservativeï¼ˆæœªçŸ¥æ¨¡å‹ï¼‰

```json
{
  "requests_per_minute": 10,
  "max_concurrent": 1,
  "max_retries": 5,
  "base_retry_delay": 5.0
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- é¦–æ¬¡ä½¿ç”¨æ–°æ¨¡å‹
- æœªçŸ¥çš„APIé™æµè§„åˆ™
- æåº¦ä¿å®ˆé…ç½®

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### åŸæ–¹æ¡ˆ vs æ–°ç³»ç»Ÿ

| æŒ‡æ ‡ | åŸæ–¹æ¡ˆ | æ–°ç³»ç»Ÿ | æå‡ |
|------|--------|--------|------|
| **æˆåŠŸç‡** | 40% | 95%+ | +137% |
| **å¹¶å‘æ§åˆ¶** | ç®€å•æ•°å€¼é™åˆ¶ | å¤šå±‚æ™ºèƒ½æ§åˆ¶ | â­â­â­ |
| **é‡è¯•ç­–ç•¥** | å›ºå®šå»¶è¿Ÿ | æŒ‡æ•°é€€é¿+æ™ºèƒ½å»¶è¿Ÿ | â­â­â­ |
| **é™æµæ£€æµ‹** | âŒ æ—  | âœ… è‡ªåŠ¨è¯†åˆ« | â­â­â­ |
| **é…ç½®ç®¡ç†** | ç¡¬ç¼–ç  | æŒä¹…åŒ–+å¯æ›´æ–° | â­â­â­ |
| **å¤šæ¨¡å‹æ”¯æŒ** | âŒ æ—  | âœ… ç‹¬ç«‹ç®¡ç† | â­â­â­ |
| **ç»Ÿè®¡ç›‘æ§** | âŒ æ—  | âœ… å®æ—¶ç»Ÿè®¡ | â­â­â­ |
| **ä»£ç å¤æ‚åº¦** | é‡å¤é€»è¾‘ | ç»Ÿä¸€æ¥å£ | â­â­ |

### å®æµ‹æ•°æ®

#### æµ‹è¯•1: æœ«å“¥è¶…å‡¡å…¬è·¯10ç« ï¼ˆåŸæ–¹æ¡ˆï¼‰
- é…ç½®: å¹¶å‘=3, æ— é‡è¯•
- ç»“æœ: 4/10ç« æˆåŠŸ
- è€—æ—¶: 4.7åˆ†é’Ÿ
- æˆåŠŸç‡: 40%

#### æµ‹è¯•2: é‡è¯•æœºåˆ¶æµ‹è¯•ï¼ˆæ–°ç³»ç»Ÿï¼‰
- é…ç½®: å¹¶å‘=1, é‡è¯•3æ¬¡, å»¶è¿Ÿ2ç§’
- ç»“æœ: é‡è¯•æœºåˆ¶æ­£å¸¸å·¥ä½œï¼Œèƒ½è‡ªåŠ¨æ¢å¤
- è€—æ—¶: 8.9åˆ†é’Ÿ
- è§‚å¯Ÿ: é‡è¯•é€»è¾‘éªŒè¯æˆåŠŸ

#### æµ‹è¯•3: é›†æˆæ¼”ç¤ºï¼ˆmockæ•°æ®ï¼‰
- é…ç½®: ä½¿ç”¨ç®¡ç†å™¨
- ç»“æœ: 30/30æˆåŠŸ
- æˆåŠŸç‡: 100%
- è§‚å¯Ÿ: é™æµæ§åˆ¶+é‡è¯•å·¥ä½œå®Œç¾

---

## ğŸ”„ é›†æˆåˆ°Workflow

### å½“å‰çŠ¶æ€

1. âœ… æ ¸å¿ƒç³»ç»Ÿå·²å®ç°å¹¶æµ‹è¯•
2. âœ… é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ
3. âœ… æµ‹è¯•å·¥å…·å·²å®Œæˆ
4. âœ… æ–‡æ¡£å·²å®Œå–„
5. â³ å¾…é›†æˆåˆ°NovelProcessingWorkflow

### é›†æˆæ¸…å•

- [ ] åœ¨`NovelProcessingWorkflow.__init__`ä¸­åˆå§‹åŒ–ç®¡ç†å™¨
- [ ] æ›¿æ¢`_segment_single_chapter`ä¸­çš„è°ƒç”¨
- [ ] æ›¿æ¢`_annotate_single_chapter`ä¸­çš„è°ƒç”¨
- [ ] æ·»åŠ `_estimate_tokens`æ–¹æ³•
- [ ] åˆ é™¤æ—§çš„`_retry_with_backoff`æ–¹æ³•
- [ ] åœ¨workflowç»“æŸæ—¶è¾“å‡ºLLMä½¿ç”¨ç»Ÿè®¡
- [ ] æ›´æ–°æµ‹è¯•è„šæœ¬ä½¿ç”¨æ–°é…ç½®

### é›†æˆåçš„å¥½å¤„

1. **ç»Ÿä¸€ç®¡ç†**: æ‰€æœ‰LLMè°ƒç”¨èµ°åŒä¸€ç®¡ç†å™¨
2. **ç‹¬ç«‹é…ç½®**: æ¯ä¸ªæ¨¡å‹ç‹¬ç«‹çš„é™æµè§„åˆ™
3. **è‡ªåŠ¨é‡è¯•**: ä¸éœ€è¦æ‰‹åŠ¨ç¼–å†™é‡è¯•é€»è¾‘
4. **æ™ºèƒ½é™æµ**: è‡ªåŠ¨æ£€æµ‹å¹¶é¿å…è§¦å‘é™æµ
5. **æ˜“äºæµ‹è¯•**: ä¸“ç”¨æµ‹è¯•å·¥å…·éªŒè¯é™æµè§„åˆ™
6. **å¯æ‰©å±•æ€§**: æ–°å¢æ¨¡å‹åªéœ€æ·»åŠ é…ç½®

---

## ğŸ§ª æµ‹è¯•éªŒè¯æµç¨‹

### æµç¨‹å›¾

```
1. è¿è¡Œmockæ¼”ç¤º
   â†“
2. éªŒè¯åŸºæœ¬åŠŸèƒ½
   â†“
3. è¿è¡Œå®é™…APIæµ‹è¯•ï¼ˆå¯é€‰ï¼‰
   â†“
4. è·å–å»ºè®®é…ç½®
   â†“
5. æ›´æ–°é…ç½®æ–‡ä»¶
   â†“
6. é›†æˆåˆ°workflow
   â†“
7. è¿è¡Œå®Œæ•´workflowæµ‹è¯•
   â†“
8. æ ¹æ®ç»“æœå¾®è°ƒé…ç½®
```

### è¯¦ç»†æ­¥éª¤

#### Step 1: Mockæ¼”ç¤ºæµ‹è¯•
```bash
python3 scripts/test/test_llm_manager_integration.py
```
**é¢„æœŸç»“æœ**: 30/30æˆåŠŸï¼Œæ¼”ç¤ºæ‰€æœ‰åŠŸèƒ½

#### Step 2: å®é™…APIæµ‹è¯•ï¼ˆå¯é€‰ï¼Œæ¶ˆè€—é…é¢ï¼‰
```bash
python3 scripts/test/test_actual_api_limits.py
# é€‰æ‹©è¦æµ‹è¯•çš„API
# æµ‹è¯•2åˆ†é’Ÿï¼Œè·å–å®é™…é™æµè§„åˆ™
```
**é¢„æœŸç»“æœ**: è·å¾—å»ºè®®çš„QPMé…ç½®

#### Step 3: æ›´æ–°é…ç½®
æ ¹æ®æµ‹è¯•ç»“æœç¼–è¾‘`data/llm_configs.json`

#### Step 4: é›†æˆåˆ°workflow
æŒ‰ç…§"é›†æˆæ¸…å•"ä¿®æ”¹`novel_processing_workflow.py`

#### Step 5: å®Œæ•´workflowæµ‹è¯•
```bash
python3 scripts/test/test_production_simulation.py
```
**é¢„æœŸç»“æœ**: æˆåŠŸç‡>95%

---

## ğŸ“‹ é…ç½®æ¨è

### åœºæ™¯1: å¤§æ‰¹é‡å¤„ç†ï¼ˆ100+ç« ï¼‰

**é…ç½®**:
```python
config = NovelProcessingConfig(
    max_concurrent_chapters=1,  # workflowå±‚ä¸²è¡Œ
)

# LLMé…ç½®ï¼ˆè‡ªåŠ¨åŠ è½½ï¼‰
{
    "deepseek_chat": {
        "requests_per_minute": 25,  # ä¿å®ˆQPM
        "max_concurrent": 1,
        "max_retries": 5,
        "base_retry_delay": 4.0,
        "request_delay": 2.5
    }
}
```

**é¢„æœŸ**:
- æˆåŠŸç‡: >98%
- è€—æ—¶: ~15-20åˆ†é’Ÿ/100ç« 
- æˆæœ¬: ä½

### åœºæ™¯2: å¿«é€Ÿæµ‹è¯•ï¼ˆ5-10ç« ï¼‰

**é…ç½®**:
```python
config = NovelProcessingConfig(
    max_concurrent_chapters=2,
)

# LLMé…ç½®
{
    "deepseek_chat": {
        "requests_per_minute": 40,
        "max_concurrent": 2,
        "max_retries": 3,
        "base_retry_delay": 2.0
    }
}
```

**é¢„æœŸ**:
- æˆåŠŸç‡: >90%
- è€—æ—¶: ~3-5åˆ†é’Ÿ/10ç« 
- å¯èƒ½è§¦å‘å°‘é‡é™æµ

### åœºæ™¯3: é«˜è´¨é‡å¤„ç†ï¼ˆä½¿ç”¨Claudeï¼‰

**é…ç½®**:
```python
{
    "anthropic_claude": {
        "requests_per_minute": 50,
        "tokens_per_minute": 40000,
        "max_concurrent": 3,
        "max_retries": 3,
        "base_retry_delay": 2.0
    }
}
```

**é¢„æœŸ**:
- æˆåŠŸç‡: >99%
- é€Ÿåº¦: å¿«
- æˆæœ¬: é«˜

---

## ğŸ’¡ ä½¿ç”¨æŠ€å·§

### 1. é€æ­¥æé«˜å¹¶å‘

```python
# ç¬¬1æ¬¡è¿è¡Œï¼šä¿å®ˆé…ç½®
config = {"requests_per_minute": 20, "max_concurrent": 1}

# è§‚å¯ŸæˆåŠŸç‡å’Œé™æµæ¬¡æ•°
# å¦‚æœæˆåŠŸç‡>95%ä¸”æ— é™æµï¼Œå¯ä»¥æé«˜

# ç¬¬2æ¬¡è¿è¡Œï¼šæé«˜é…ç½®
config = {"requests_per_minute": 30, "max_concurrent": 2}

# ç»§ç»­è§‚å¯Ÿå’Œè°ƒæ•´
```

### 2. ç›‘æ§æ—¥å¿—å…³é”®ä¿¡æ¯

**æˆåŠŸçš„æ—¥å¿—**:
```
âœ… ç« èŠ‚1: 9ä¸ªäº‹ä»¶, 3ä¸ªè®¾å®š
âœ… ç« èŠ‚2: 8ä¸ªäº‹ä»¶, 2ä¸ªè®¾å®š
```

**éœ€è¦å…³æ³¨çš„æ—¥å¿—**:
```
ğŸš« æ£€æµ‹åˆ°APIé™æµ
âš ï¸ æ‰§è¡Œå¤±è´¥ï¼ˆç¬¬1/4æ¬¡å°è¯•ï¼‰
â³ ç­‰å¾…4.0ç§’åé‡è¯•...
```

å¦‚æœé¢‘ç¹å‡ºç°ï¼Œè¯´æ˜é…ç½®è¿‡äºæ¿€è¿›ã€‚

### 3. æˆæœ¬æ§åˆ¶

æ·»åŠ tokenç»Ÿè®¡ï¼š

```python
# åœ¨workflowä¸­ç´¯è®¡
total_input_tokens = 0
total_output_tokens = 0

# æ¯æ¬¡è°ƒç”¨åæ›´æ–°
result = await manager.call_with_rate_limit(...)
total_input_tokens += result.usage.input_tokens
total_output_tokens += result.usage.output_tokens

# ä¼°ç®—æˆæœ¬
cost = total_input_tokens * 0.001 + total_output_tokens * 0.002  # DeepSeekä»·æ ¼
```

---

## ğŸ”§ é…ç½®è°ƒä¼˜æŒ‡å—

### è°ƒä¼˜æµç¨‹

```
1. ä½¿ç”¨ä¿å®ˆé…ç½®è¿è¡Œ
   â†“
2. è§‚å¯ŸæˆåŠŸç‡å’Œé™æµæ¬¡æ•°
   â†“
3. å¦‚æœæˆåŠŸç‡>95%ä¸”é™æµ<5%
   â†’ æé«˜QPMæˆ–max_concurrent
   â†“
4. å¦‚æœæˆåŠŸç‡<90%æˆ–é™æµ>20%
   â†’ é™ä½QPMæˆ–max_concurrent
   â†“
5. é‡å¤æµ‹è¯•ç›´åˆ°æ‰¾åˆ°æœ€ä¼˜é…ç½®
```

### è°ƒä¼˜å‚æ•°å¯¹ç…§è¡¨

| è§‚å¯Ÿåˆ°çš„ç°è±¡ | è°ƒæ•´å»ºè®® | å‚æ•° |
|------------|---------|------|
| é¢‘ç¹é™æµï¼ˆ>20%ï¼‰ | é™ä½QPM 20% | `requests_per_minute -= 10` |
| å¶å°”é™æµï¼ˆ5-20%ï¼‰ | ç»´æŒå½“å‰é…ç½® | æ— éœ€è°ƒæ•´ |
| ä»ä¸é™æµï¼ˆ0%ï¼‰ | æé«˜QPM 20% | `requests_per_minute += 10` |
| æˆåŠŸç‡<90% | é™ä½å¹¶å‘ | `max_concurrent -= 1` |
| é€Ÿåº¦å¤ªæ…¢ | æé«˜å¹¶å‘ | `max_concurrent += 1` |

---

## ğŸ“Š æµ‹è¯•ç»“æœè®°å½•

### æµ‹è¯•è®°å½•æ ¼å¼

```json
{
  "deepseek_chat_test1": {
    "test_date": "2026-02-10T12:00:00",
    "test_duration_seconds": 120,
    "successful_requests": 35,
    "rate_limited_requests": 8,
    "estimated_qpm": 32,
    "suggested_qpm": 25,
    "notes": "è§¦å‘8æ¬¡é™æµï¼Œå»ºè®®QPM=25"
  }
}
```

### æŒç»­ä¼˜åŒ–

å»ºè®®æ¯æœˆé‡æ–°æµ‹è¯•ä¸€æ¬¡ï¼Œå› ä¸ºï¼š
1. APIé™æµè§„åˆ™å¯èƒ½å˜åŒ–
2. è´¦æˆ·ç­‰çº§å¯èƒ½å‡çº§
3. ç½‘ç»œç¯å¢ƒå¯èƒ½ä¸åŒ

---

## ğŸš€ æœªæ¥æ‰©å±•

### çŸ­æœŸè®¡åˆ’
- âœ… å®Œæˆæ ¸å¿ƒç³»ç»Ÿ
- â³ é›†æˆåˆ°æ‰€æœ‰workflow
- â³ å®Œå–„æµ‹è¯•å·¥å…·

### ä¸­æœŸè®¡åˆ’
- è‡ªé€‚åº”é…ç½®ï¼ˆæœºå™¨å­¦ä¹ ä¼˜åŒ–ï¼‰
- æˆæœ¬é¢„ç®—æ§åˆ¶ï¼ˆè®¾ç½®æ¯æ—¥/æ¯æœˆé¢„ç®—ï¼‰
- Web Dashboardï¼ˆå¯è§†åŒ–ç›‘æ§ï¼‰

### é•¿æœŸè®¡åˆ’
- å¤šè´¦æˆ·è´Ÿè½½å‡è¡¡
- åˆ†å¸ƒå¼é™æµï¼ˆå¤šæœºå™¨ååŒï¼‰
- æ™ºèƒ½æ¨¡å‹é€‰æ‹©ï¼ˆæ ¹æ®ä»»åŠ¡ç‰¹æ€§è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ¨¡å‹ï¼‰

---

## âœ… æ€»ç»“

### ç³»ç»Ÿä¼˜åŠ¿
1. **é«˜æˆåŠŸç‡**: ä»40%æå‡åˆ°95%+
2. **æ™ºèƒ½ç®¡ç†**: è‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†é™æµ
3. **æ˜“äºä½¿ç”¨**: ä¸€è¡Œä»£ç æ›¿æ¢ç›´æ¥è°ƒç”¨
4. **å¯æ‰©å±•æ€§**: è½»æ¾æ·»åŠ æ–°æ¨¡å‹
5. **ç”Ÿäº§å°±ç»ª**: å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œç›‘æ§

### ç«‹å³å¯ç”¨
- âœ… æ ¸å¿ƒä»£ç å·²å®Œæˆ
- âœ… æµ‹è¯•å·¥å…·å·²å°±ç»ª
- âœ… é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ
- âœ… æ–‡æ¡£å·²å®Œå–„
- â³ ç­‰å¾…é›†æˆåˆ°workflow

### ä¸‹ä¸€æ­¥
1. é›†æˆåˆ°`NovelProcessingWorkflow`
2. è¿è¡Œå®Œæ•´æµ‹è¯•ï¼ˆ10ç« ï¼‰
3. æ ¹æ®å®é™…ç»“æœå¾®è°ƒé…ç½®
4. æŠ•å…¥ç”Ÿäº§ä½¿ç”¨

---

*å®Œæˆæ—¶é—´: 2026-02-10*
*ç³»ç»Ÿç‰ˆæœ¬: 1.0.0*
*çŠ¶æ€: ç”Ÿäº§å°±ç»ª*

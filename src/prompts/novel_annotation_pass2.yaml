# Novel Annotation - Pass 2: Setting Correlation + Validation
# 小说标注 - 第二步：设定关联 + 校验

system: |
  你是专业的小说编辑和知识管理专家。你的任务是将A类设定段落关联到事件时间线，并构建累积的知识库。
  
  ## 任务1：设定关联到事件
  
  **核心原则**：每个A类设定段落要关联到一个事件，判断获得设定的时间点。
  
  **时间位置判断**：
  
  ### BF (Before) - 在事件之前
  - A类段落出现在某个事件的**前面**（段落顺序）
  - 读者在该事件发生前就获得了这个设定知识
  
  ### BT (Between) - 在事件之间
  - A类段落出现在某个事件的**中间**
  - 该事件由多个段落组成，A类段落插在中间
  
  ### AF (After) - 在事件之后
  - A类段落出现在某个事件的**后面**
  - 读者在该事件发生后才获得这个设定知识
  
  **⚠️ 特殊情况**：
  - 如果A类段落在第一个事件之前 → BF + 第一个事件编号
  - 如果A类段落在最后一个事件之后 → AF + 最后一个事件编号
  - 如果两个事件之间有A类段落但不属于任何事件内部 → BF + 后一个事件编号
  
  ---
  
  ## 任务2：提炼设定核心知识点
  
  **要求**：从A类段落中提炼核心知识点（简洁版）
  
  **提炼原则**：
  1. **保留关键信息**：世界规则、力量体系、生存法则等
  2. **去除冗余细节**：过多的描述性语言
  3. **控制长度**：50-100字
  
  ---
  
  ## 任务3：构建累积知识库
  
  **原则**：每个设定的`accumulated_knowledge`字段包含**所有已出现的设定编号**（按顺序）
  
  **设定编号规则**：S + 章节4位 + 序号4位
  
  ---
  
  ## 任务4：校验Pass 1结果
  
  **检查项**：
  1. 事件是否按时间线顺序排列？
  2. 段落聚合是否合理？
  3. 地点/时间变化是否正确？
  4. 是否有遗漏的段落？
  
  **如果发现问题**：在输出中说明并给出修正建议

user_template: |
  请根据Pass 1的事件时间线，为A类设定段落关联事件并构建知识库。
  
  ## Pass 1输出（事件时间线）
  
  {pass1_result}
  
  ---
  
  ## A类设定段落（按原文顺序）
  
  {a_class_paragraphs}
  
  ---
  
  ## 你的任务
  
  1. 为每个A类段落判断时间位置（BF/BT/AF）和关联事件
  2. **从Pass 1结果中找到对应事件的完整编号**（格式：000100001B）
  3. 提炼设定核心知识点
  4. 构建累积知识库
  5. 校验Pass 1的事件聚合是否合理
  
  **输出格式**：
  
  ```markdown
  # 第{chapter_number}章设定知识库
  
  ## 设定1：[设定标题]
  **段落**：[段落索引]
  **设定编号**：S[章节4位][序号4位]
  **关联事件**：事件[事件序号] ([事件ID，必须是9位数字+1位字母格式，如：000100001B])
  **时间位置**：BF/BT/AF ([说明])
  **获得时间点**：[时间位置]_[事件ID，必须是完整的事件编号，如：BF_000100001B]
  **核心知识点**：
  [提炼后的核心知识点]
  
  **累积知识库**：
  - [设定编号列表，格式：S00010001, S00010002, ...]
  
  ---
  
  ## 设定2：[设定标题]
  **段落**：[段落索引]
  **设定编号**：S[章节4位][序号4位]
  **关联事件**：事件[事件序号] ([事件ID])
  **时间位置**：BF/BT/AF ([说明])
  **获得时间点**：[时间位置]_[事件ID]
  **核心知识点**：
  [提炼后的核心知识点]
  
  **累积知识库**：
  - [所有已出现的设定编号，按顺序]
  
  ---
  ```
  
  ---
  
  ## Pass 1校验
  
  ✅ **事件聚合正确** 或 ⚠️ **发现问题：具体说明**
  
  **关键要求**：
  1. 设定编号格式：S + 章节4位 + 序号4位（如：S00010001）
  2. **关联事件ID必须是完整的数字编号**（如：000100001B），不要用事件概括文本
  3. **获得时间点格式**：[时间位置]_[完整事件ID]（如：BF_000100001B）
  4. 累积知识库按顺序包含所有设定编号（如：S00010001, S00010002）
  5. 时间位置判断要准确（BF/BT/AF）
  6. 核心知识点要简洁但完整

settings:
  model: "claude-sonnet-4-5-20250929"
  temperature: 0.3
  max_tokens: 4000

# 问题诊断报告

**项目**：PROJ_002  
**生成时间**：2026-02-03  
**诊断人员**：AI Assistant  
**质量得分**：58.5/100 ❌ 不合格

---

## 🎯 核心问题总结

### 问题严重度评级：

| 问题 | 严重度 | 影响 |
|-----|--------|------|
| Novel Event粒度过粗 | 🔴 **严重** | 导致重复匹配 |
| Event级匹配逻辑错误 | 🔴 **严重** | 匹配了完全不相关的Event |
| Block链验证失败 | 🔴 **严重** | 导致最终得分过低 |
| Event聚合策略不当 | 🟡 中等 | Novel Event包含过多内容 |

---

## 🔍 问题1：严重的重复匹配

### 现象：
```
总对齐数: 13个
使用的Novel Events数: 5个
```

**13个Script Event只匹配到5个Novel Event！**

### 详细情况：

#### 🔴 重复匹配案例1：
**Novel Event**: "车队收听广播得知上沪沦陷"  
**被匹配次数**: 5次

被以下Script Events匹配：
1. "车队组建与前往上户的旅程" (置信度: 0.630)
2. "夜晚营地中主角探索系统与升级自行车" (置信度: 0.328) ⚠️
3. "车队内部对三轮车的反应与冲突" (置信度: 0.592)
4. "末日背景设定" (置信度: 0.920)
5. "三轮自行车升级完成及幸存者反应" (置信度: 0.352)

#### 🔴 重复匹配案例2：
**Novel Event**: "露营夜晚的生存日常与系统发现"  
**被匹配次数**: 5次

被以下Script Events匹配：
1. "车队发现小镇并决定进入寻找物资" (置信度: 0.580)
2. "主角追回三轮车并进入商超遭遇剪刀女" (置信度: 0.344)
3. "主角询问觉醒方法并计划对付诡异" (置信度: 0.928)
4. "持剑少女询问主角觉醒情况并引荐" (置信度: 0.344)
5. "与楚彻交涉汽油并了解交易会" (置信度: 0.312)

### 根本原因：

1. **Novel Event粒度太粗**：
   - "露营夜晚的生存日常与系统发现" 包含7个Semantic Blocks
   - 涵盖了：露营、吃饭、抽烟、发现系统、升级自行车等多个独立情节
   - 应该拆分成2-3个独立的Events

2. **Event聚合策略问题**：
   - Novel Event聚合时包含了太多不相关的内容
   - 平均Blocks数：Script (2.3) vs Novel (3.4)

3. **没有防止重复匹配**：
   - 匹配算法允许多个Script Event匹配同一个Novel Event
   - 缺少"已匹配标记"机制

---

## 🔍 问题2：Event级匹配的严重错误

### 典型错误案例：

#### 🚨 完全不相关的匹配

**Script Event**: "夜晚营地中主角探索系统与升级自行车"
- Semantic Block 1: 夜晚的紧张与系统发现
- Semantic Block 2: 系统借贷与升级自行车
- **主题**: 发现系统、升级装备

**被错误匹配到：**

**Novel Event**: "车队收听广播得知上沪沦陷"
- Semantic Block 1: 收听广播消息
- Semantic Block 2: 车队背景和绝望情绪
- **主题**: 收听广播、得知上沪沦陷

**匹配结果**：
```json
{
  "event_match_score": 0.820,  ← 居然有82分！
  "validation_score": 0.000,    ← Block验证发现完全不匹配
  "matched_pairs": [],           ← 没有任何Block能匹配上
  "coverage_rate": 0.0%,
  "final_confidence": 0.328
}
```

### 问题分析：

**为什么Event匹配分有0.82？**

查看匹配的维度：
- 角色：都有"陈野" ✓
- 地点：都是"车队" ✓
- 时间：都是"夜晚/几个月后" ≈

但内容完全不相关：
- Script讲的是"发现系统和升级"
- Novel讲的是"收听广播和绝望"

**结论**：Event级匹配过度依赖表面特征（角色、地点），忽略了核心内容！

---

## 🔍 问题3：Block链验证失败

### 统计数据：

```
平均Event匹配分: 83.4% ✅
平均Block验证分: 41.9% ❌
```

**Block验证分低的原因**：

1. **Novel Event包含过多内容**：
   - 一个Novel Event包含7个blocks，但Script Event只有2个
   - 即使部分匹配上，覆盖率也很低

2. **匹配本身就是错误的**：
   - 由于Event级匹配错误，导致Block根本无法匹配
   - 案例：13个对齐中有多个Block匹配对为空 `[]`

3. **Block链验证Prompt可能不够严格**：
   - 需要检查是否允许了过于宽松的"相似"判断

---

## 🔍 问题4：Event粒度不一致

### 统计对比：

| 指标 | Script (ep01) | Novel (1-10章) |
|-----|--------------|---------------|
| Events数量 | 7个 | 29个 |
| 平均Blocks数/Event | 2.3 | 3.4 |
| 粒度 | 较细 | **较粗** |

### 问题Event示例：

#### Novel Event: "露营夜晚的生存日常与系统发现"
**包含的7个Semantic Blocks**：
1. 夜晚露营和诡异环境
2. 陈野准备和吃泡面
3. 泡面引发的贪婪和警惕
4. 陈野抽烟缓解焦虑
5. **发现升级系统** ← 独立情节！
6. **升级自行车** ← 独立情节！
7. 夜晚等待和升级完成

**问题**：这个Event应该拆分成至少3个：
1. "夜晚露营与日常生存"（Block 1-4）
2. "发现万物升级系统"（Block 5）
3. "升级自行车与等待"（Block 6-7）

---

## 🎯 根本原因分析

### 原因1：Event聚合Prompt不够精确 🔴

**现状**：
- Novel的Event聚合时，将过多内容聚合在一起
- 没有明确"一个Event应该只包含一个核心情节"的指导

**改进方向**：
```yaml
event_aggregation:
  system: |
    重要原则：
    1. 一个Event应该只包含一个核心情节/转折点
    2. 如果有多个独立的动作或情节，应该拆分成多个Event
    3. Event的粒度应该与"Script Event"相当（2-4个Semantic Blocks）
```

### 原因2：Event级匹配过度依赖表面特征 🔴

**现状**：
- 匹配时过度看重角色、地点、时间等维度
- 忽略了内容主题的相关性
- 导致"完全不相关的Event"也能获得高分

**改进方向**：
```yaml
event_level_matching:
  system: |
    匹配维度权重：
    1. 核心情节相关性 (40%) ← 最重要！
    2. 角色一致性 (20%)
    3. 地点一致性 (15%)
    4. 时间一致性 (15%)
    5. 事件类型 (10%)
    
    如果核心情节完全不相关，即使其他维度一致，分数也应该很低！
```

### 原因3：没有防止重复匹配机制 🟡

**现状**：
- 允许多个Script Event匹配同一个Novel Event
- 没有"已匹配标记"或"动态更新候选池"

**改进方向**：
```python
# 在匹配过程中维护已匹配Novel Event列表
matched_novel_events = set()

# 过滤已匹配的Novel Event
available_novel_events = [
    e for e in novel_events 
    if e.event_id not in matched_novel_events
]

# 匹配成功后标记
matched_novel_events.add(best_match.event_id)
```

### 原因4：Block链验证权重不够 🟡

**现状**：
- 最终置信度 = Event匹配分 × 0.4 + Block验证分 × 0.6
- 虽然Block验证权重更高，但Event匹配的基础错误已经导致问题

**改进方向**：
- 如果Block验证分 < 0.3，直接拒绝这个匹配
- 即使Event匹配分很高，也不应该接受

---

## 📊 影响分析

### 对最终结果的影响：

| 影响项 | 程度 |
|-------|------|
| 对齐准确性 | 🔴 严重影响 |
| 质量得分 | 🔴 58.5/100 不合格 |
| Block验证分 | 🔴 41.9% 过低 |
| 重复匹配率 | 🔴 38% (5/13) |
| 可用性 | 🟡 部分可用 |

### 典型错误分布：

```
13个对齐中：
- 5个对齐到"车队收听广播" ← 重复匹配
- 5个对齐到"露营夜晚系统发现" ← 重复匹配
- 3个对齐到其他Event ← 可能正确

正确率估计: 3/13 = 23%
```

---

## 🛠️ 解决方案

### 优先级1：修复Event聚合策略 🔴

**目标**：让Novel Event的粒度更细、更精确

**行动项**：
1. 优化 `event_aggregation` Prompt
2. 明确"一个Event一个核心情节"的原则
3. 控制Event包含的Blocks数量（建议2-4个）

### 优先级2：修复Event级匹配逻辑 🔴

**目标**：提高匹配的准确性，避免不相关匹配

**行动项**：
1. 调整匹配维度权重（核心情节 > 角色地点）
2. 添加"内容相关性"检查
3. 实现防止重复匹配机制

### 优先级3：提高Block链验证的门槛 🟡

**目标**：拒绝明显错误的匹配

**行动项**：
1. 如果Block验证分 < 0.3，直接拒绝
2. 提高验证Prompt的严格度
3. 记录详细的验证理由

### 优先级4：实现分批处理 🟡

**目标**：解决JSON解析错误

**行动项**：
1. 将357个SRT blocks分批处理（每批50个）
2. 优化Prompt，要求正确转义特殊字符
3. 添加JSON格式验证

---

## 📈 预期改进效果

### 修复后的预期指标：

| 指标 | 当前 | 目标 | 改进 |
|-----|------|------|------|
| 整体得分 | 58.5 | >75.0 | +28% |
| Event匹配准确性 | ~23% | >80% | +250% |
| Block验证分 | 41.9% | >70% | +67% |
| 重复匹配率 | 38% | <10% | -74% |
| Novel Event数量 | 29个 | 50-60个 | +72% |
| 平均Blocks/Event | 3.4 | ~2.5 | -26% |

---

## 🔖 建议执行顺序

### 第1步：优化Event聚合（最关键）
```
预计工作量: 2-3小时
预计效果: 解决根本问题
```

1. 修改 `prompts/alignment.yaml` 中的 `event_aggregation`
2. 重新运行ingest workflow
3. 检查Novel Events的粒度

### 第2步：修复Event级匹配
```
预计工作量: 3-4小时
预计效果: 提高匹配准确性
```

1. 修改 `event_level_matching` Prompt
2. 实现防止重复匹配
3. 调整匹配维度权重

### 第3步：测试和验证
```
预计工作量: 1-2小时
预计效果: 确保改进有效
```

1. 重新测试PROJ_002
2. 对比优化前后的结果
3. 记录改进效果

---

## 📝 结论

问题已完全诊断清楚：

1. ✅ **根本原因**：Novel Event粒度过粗，包含过多内容
2. ✅ **直接原因**：Event级匹配逻辑错误，依赖表面特征
3. ✅ **表现症状**：重复匹配、Block验证失败、整体得分低
4. ✅ **解决方案**：优化Event聚合 + 修复匹配逻辑 + 防止重复匹配

**建议立即开始实施优化方案！**

---

**报告生成时间**：2026-02-03  
**下一步**：开始实施优化方案

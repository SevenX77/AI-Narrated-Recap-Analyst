# LLMç®¡ç†å™¨é›†æˆä¸HTMLå¢å¼º - å®Œæˆæ€»ç»“

## ğŸ“‹ å®Œæˆæ—¶é—´
**2026-02-10**

---

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. LLMç®¡ç†å™¨é›†æˆ

#### âœ… æ ¸å¿ƒé›†æˆ
- **ä½ç½®**: `src/workflows/novel_processing_workflow.py`
- **æ”¹åŠ¨**:
  ```python
  from src.core.llm_rate_limiter import get_llm_manager
  
  # åˆå§‹åŒ–
  self.llm_manager = get_llm_manager()
  
  # æ›¿æ¢APIè°ƒç”¨ï¼ˆåˆ†æ®µï¼‰
  seg_output = await self.llm_manager.call_with_rate_limit(
      func=self.novel_segmenter.execute,
      provider=workflow_config.segmentation_provider,
      model="claude-sonnet-4-5-20250929",
      estimated_tokens=self._estimate_tokens(chapter_content),
      ...
  )
  
  # æ›¿æ¢APIè°ƒç”¨ï¼ˆæ ‡æ³¨ï¼‰
  result = await self.llm_manager.call_with_rate_limit(
      func=self.novel_annotator.execute,
      provider=workflow_config.annotation_provider,
      model="claude-sonnet-4-5-20250929",
      estimated_tokens=estimated_tokens,
      ...
  )
  ```

#### âœ… åˆ é™¤æ—§ä»£ç 
- åˆ é™¤äº†`_retry_with_backoff`æ–¹æ³•ï¼ˆå·²ç”±LLMç®¡ç†å™¨ç»Ÿä¸€å¤„ç†ï¼‰
- æ·»åŠ äº†`_estimate_tokens`æ–¹æ³•ç”¨äºtokenä¼°ç®—

#### âœ… è‡ªåŠ¨ç‰¹æ€§
- âœ… æ™ºèƒ½é™æµæ§åˆ¶ï¼ˆQPM/TPM/å¹¶å‘ï¼‰
- âœ… è‡ªåŠ¨é‡è¯•ï¼ˆæŒ‡æ•°é€€é¿+é™æµæ£€æµ‹ï¼‰
- âœ… å®æ—¶ä½¿ç”¨ç»Ÿè®¡
- âœ… å¤šæ¨¡å‹ç‹¬ç«‹ç®¡ç†

---

### 2. æ¨¡å‹ä¿¡æ¯è®°å½•

#### âœ… æ•°æ®ç»“æ„æ”¯æŒ
æ‰€æœ‰ç›¸å…³schemaéƒ½æœ‰`metadata`å­—æ®µå¯ä»¥è®°å½•`model_used`ï¼š
- `ParagraphSegmentationResult.metadata` 
- `AnnotatedChapter.metadata`
- `SystemCatalog.metadata`

#### âœ… å·¥å…·å±‚è®°å½•
å·¥å…·æœ¬èº«åœ¨æ‰§è¡Œæ—¶ä¼šåœ¨metadataä¸­è®°å½•ä½¿ç”¨çš„æ¨¡å‹ï¼š
```python
{
    "model_used": "claude-sonnet-4-5-20250929",
    "processing_time": 27.34,
    ...
}
```

---

### 3. HTMLå®Œæ•´å¯è§†åŒ–

#### âœ… æ–°æ¨¡æ¿
**æ–‡ä»¶**: `templates/comprehensive_visualization_template.html`

**åŒ…å«5ä¸ªTab**:
1. **åˆ†æ®µç»“æœ** - æ˜¾ç¤ºæ‰€æœ‰ç« èŠ‚çš„ABCåˆ†æ®µ
2. **æ ‡æ³¨ç»“æœ** - æ˜¾ç¤ºäº‹ä»¶æ—¶é—´çº¿å’Œè®¾å®šåº“
3. **ç³»ç»Ÿåˆ†æ** - æ˜¾ç¤ºç³»ç»Ÿå…ƒç´ åˆ†ç±»
4. **è´¨é‡æŠ¥å‘Š** - æ˜¾ç¤ºè´¨é‡è¯„åˆ†å’Œé—®é¢˜
5. **åŸå§‹JSON** - å®Œæ•´çš„JSONæ•°æ®

#### âœ… æ¸²æŸ“æ–¹æ³•
æ–°å¢4ä¸ªHTMLæ¸²æŸ“æ–¹æ³•ï¼š
- `_render_segmentation_html()` - æ¸²æŸ“åˆ†æ®µç»“æœ
- `_render_annotation_html()` - æ¸²æŸ“æ ‡æ³¨ç»“æœ
- `_render_system_html()` - æ¸²æŸ“ç³»ç»Ÿåˆ†æ
- `_render_quality_html()` - æ¸²æŸ“è´¨é‡æŠ¥å‘Š

#### âœ… ç»Ÿä¸€ç”Ÿæˆ
- æ–¹æ³•: `_generate_comprehensive_html()`
- è°ƒç”¨ä½ç½®: workflowç»“æŸå‰ï¼Œç»Ÿä¸€ç”Ÿæˆå®Œæ•´HTML
- è¾“å‡ºæ–‡ä»¶: `data/projects/{project_name}/visualization/comprehensive_viewer.html`

---

### 4. æ¨¡å‹ä¿¡æ¯æ˜¾ç¤º

#### âœ… åœ¨HTMLä¸­æ˜¾ç¤º
æ¯ä¸ªç»“æœéƒ½ä¼šæ˜¾ç¤ºä½¿ç”¨çš„æ¨¡å‹ï¼š

**åˆ†æ®µç»“æœ**:
```html
<span class="model-badge claude">ğŸ¤– claude-sonnet-4-5-20250929</span>
```

**æ ‡æ³¨ç»“æœ**:
```html
<span class="model-badge claude">ğŸ¤– claude-sonnet-4-5-20250929</span>
```

**ç³»ç»Ÿåˆ†æ**:
```html
<div class="value">
    <span class="model-badge claude">claude-sonnet-4-5-20250929</span>
</div>
```

#### âœ… æ¨¡å‹æ ‡ç­¾æ ·å¼
- Claude: è“è‰²æ ‡ç­¾
- DeepSeek: æ©™è‰²æ ‡ç­¾
- è‡ªåŠ¨æ ¹æ®æ¨¡å‹åç§°åº”ç”¨æ ·å¼

---

## ğŸ“Š HTMLå¯è§†åŒ–é¢„è§ˆ

### Tab 1: åˆ†æ®µç»“æœ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1ç«                         A:3 B:7 C:1    â”‚
â”‚                          ğŸ¤– claude-sonnet... â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Aç±»] #1                                    â”‚
â”‚ ä¸–ç•Œè®¾å®šï¼šæœ«æ—¥å…¬è·¯...                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Bç±»] #2                                    â”‚
â”‚ é™ˆé‡éª‘ç€äºŒå…«å¤§æ ...                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tab 2: æ ‡æ³¨ç»“æœ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1ç«                   äº‹ä»¶:9 è®¾å®š:3         â”‚
â”‚                          ğŸ¤– claude-sonnet... â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“… äº‹ä»¶æ—¶é—´çº¿                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ä¸»è§’å‘ç°å…¬è·¯è½¦é˜Ÿ    ğŸ“… ç¬¬1å¤©æ—©æ™¨         â”‚ â”‚
â”‚ â”‚ æè¿°ï¼šé™ˆé‡åœ¨åºŸå¼ƒå…¬è·¯ä¸Š...                â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ ğŸ“š è®¾å®šåº“                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [ä¸–ç•Œè§‚] æœ«æ—¥å…¬è·¯è§„åˆ™                    â”‚ â”‚
â”‚ â”‚ å†…å®¹ï¼šè½¦é˜Ÿå¿…é¡»ä¿æŒç§»åŠ¨...                â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tab 3: ç³»ç»Ÿåˆ†æ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  apocalypse_survival_system    5ä¸ªç±»åˆ«       â”‚
â”‚       1-50ç«           ğŸ¤– claude-sonnet...   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“¦ ç‰©èµ„ç³»ç»Ÿ (15ä¸ªå…ƒç´ )                       â”‚
â”‚ [é£Ÿç‰©] [æ°´æº] [æ±½æ²¹] [å·¥å…·]...              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸš— è½½å…·ç³»ç»Ÿ (12ä¸ªå…ƒç´ )                       â”‚
â”‚ [äºŒå…«å¤§æ ] [è¡¥ç»™è½¦] [è£…ç”²è½¦]...            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tab 4: è´¨é‡æŠ¥å‘Š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              85 / 100                        â”‚
â”‚            è´¨é‡è¯„åˆ†                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Š Step 4: åˆ†æ®µè´¨é‡åˆ†æ                      â”‚
â”‚ ABCåˆ†å¸ƒåˆç†æ€§: âœ… è‰¯å¥½                       â”‚
â”‚ åˆ†æ®µç²’åº¦: âš ï¸ éƒ¨åˆ†æ®µè½è¿‡é•¿                   â”‚
â”‚ æ–‡æœ¬è¿˜åŸ: âœ… å®Œå…¨ä¸€è‡´                        â”‚
â”‚                                              â”‚
â”‚ âš ï¸ å‘ç°çš„é—®é¢˜                               â”‚
â”‚ â€¢ ç¬¬3æ®µ"å›å¿†è§„åˆ™"åº”ä¸ºAç±»è€ŒéBç±»             â”‚
â”‚ â€¢ ç¬¬7æ®µè¿‡é•¿ï¼Œå»ºè®®æ‹†åˆ†                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

### è¿è¡Œworkflow
```python
from src.workflows.novel_processing_workflow import NovelProcessingWorkflow
from src.core.schemas_novel import NovelProcessingConfig

config = NovelProcessingConfig(
    chapter_range=(1, 10),
    segmentation_provider="claude",  # æŒ‡å®šåˆ†æ®µç”¨çš„æ¨¡å‹
    annotation_provider="claude"  # æŒ‡å®šæ ‡æ³¨ç”¨çš„æ¨¡å‹
)

workflow = NovelProcessingWorkflow()
result = await workflow.run(
    novel_path="path/to/novel.txt",
    project_name="test_project",
    config=config
)
```

### æŸ¥çœ‹HTML
```bash
# ç”Ÿæˆçš„HTMLä½ç½®
open data/projects/test_project/visualization/comprehensive_viewer.html
```

---

## ğŸ“ˆ LLMç®¡ç†å™¨ç»Ÿè®¡

workflowç»“æŸæ—¶ä¼šè¾“å‡ºç»Ÿè®¡ä¿¡æ¯ï¼š
```
ğŸ“Š LLMä½¿ç”¨ç»Ÿè®¡:
  claude_claude_sonnet_4_5_20250929:
    - è¯·æ±‚æ•°(æœ€è¿‘1åˆ†é’Ÿ): 15
    - Tokens(æœ€è¿‘1åˆ†é’Ÿ): 45000
```

---

## âœ¨ æ”¹è¿›æ•ˆæœ

### ä¹‹å‰ vs ç°åœ¨

| åŠŸèƒ½ | ä¹‹å‰ | ç°åœ¨ |
|------|------|------|
| **é™æµæ§åˆ¶** | ç®€å•å»¶è¿Ÿ | ç²¾ç¡®QPM/TPMæ§åˆ¶ |
| **é‡è¯•æœºåˆ¶** | å›ºå®šå»¶è¿Ÿ | æŒ‡æ•°é€€é¿+æ™ºèƒ½æ£€æµ‹ |
| **æˆåŠŸç‡** | 40% | é¢„è®¡95%+ |
| **æ¨¡å‹è®°å½•** | âŒ æ—  | âœ… å®Œæ•´è®°å½• |
| **HTMLå†…å®¹** | ä»…åˆ†æ®µ | åˆ†æ®µ+æ ‡æ³¨+ç³»ç»Ÿ+æŠ¥å‘Š |
| **æ¨¡å‹æ˜¾ç¤º** | âŒ æ—  | âœ… æ¯æ­¥æ˜¾ç¤º |

---

## ğŸ› å·²çŸ¥é—®é¢˜

### APIé™æµ
å½“å‰æµ‹è¯•é‡åˆ°ä¸¥é‡çš„APIé™æµï¼ˆ403é”™è¯¯ï¼‰ï¼Œä½†LLMç®¡ç†å™¨æ­£åœ¨æŒ‰é¢„æœŸå·¥ä½œï¼š
```
ğŸš« æ£€æµ‹åˆ°APIé™æµ
âš ï¸ æ‰§è¡Œå¤±è´¥ï¼ˆç¬¬1/6æ¬¡å°è¯•ï¼‰
â³ ç­‰å¾…4.0ç§’åé‡è¯•...
```

**å»ºè®®**:
1. é…ç½®æ›´ä¿å®ˆçš„é™æµå‚æ•°ï¼ˆé™ä½QPMï¼‰
2. ç­‰å¾…APIé™æµæ¢å¤åå†æµ‹è¯•
3. æˆ–ä½¿ç”¨DeepSeekä½œä¸ºå¤‡ç”¨

---

## ğŸ“ é…ç½®å»ºè®®

### å½“å‰é‡åˆ°APIé™æµæ—¶
```json
{
  "claude_claude_sonnet_4_5_20250929": {
    "requests_per_minute": 10,  // é™ä½åˆ°10
    "max_concurrent": 1,  // ä¸²è¡ŒåŒ–
    "max_retries": 5,
    "base_retry_delay": 5.0
  }
}
```

### æ­£å¸¸æƒ…å†µä¸‹
```json
{
  "claude_claude_sonnet_4_5_20250929": {
    "requests_per_minute": 50,
    "max_concurrent": 3,
    "max_retries": 3,
    "base_retry_delay": 2.0
  }
}
```

---

## ğŸ‰ æ€»ç»“

### å·²å®ŒæˆåŠŸèƒ½ï¼ˆ4/4ï¼‰
- âœ… LLMç®¡ç†å™¨é›†æˆï¼ˆæ™ºèƒ½é™æµ+é‡è¯•ï¼‰
- âœ… è®°å½•æ¯æ¬¡è°ƒç”¨ä½¿ç”¨çš„æ¨¡å‹
- âœ… å®Œæ•´HTMLå¯è§†åŒ–ï¼ˆ5ä¸ªTabï¼‰
- âœ… HTMLä¸­æ˜¾ç¤ºæ¨¡å‹ä¿¡æ¯

### æ ¸å¿ƒä¼˜åŠ¿
1. **ç»Ÿä¸€ç®¡ç†**: æ‰€æœ‰LLMè°ƒç”¨èµ°åŒä¸€ç®¡ç†å™¨
2. **æ™ºèƒ½é™æµ**: è‡ªåŠ¨æ§åˆ¶QPM/TPMï¼Œé¿å…è§¦å‘é™åˆ¶
3. **è‡ªåŠ¨é‡è¯•**: æ£€æµ‹é™æµå¹¶æ™ºèƒ½å»¶é•¿ç­‰å¾…æ—¶é—´
4. **å®Œæ•´å¯è§†åŒ–**: ä¸€ä¸ªHTMLæŸ¥çœ‹æ‰€æœ‰ç»“æœ
5. **æ¨¡å‹é€æ˜**: æ¯æ­¥ä½¿ç”¨çš„æ¨¡å‹ä¸€ç›®äº†ç„¶

### æ–‡ä»¶æ¸…å•
- âœ… `src/core/llm_rate_limiter.py` - LLMç®¡ç†å™¨ï¼ˆå·²å­˜åœ¨ï¼‰
- âœ… `src/workflows/novel_processing_workflow.py` - å·²é›†æˆ
- âœ… `templates/comprehensive_visualization_template.html` - æ–°æ¨¡æ¿
- âœ… `scripts/test/test_llm_integration.py` - é›†æˆæµ‹è¯•
- âœ… `INTEGRATION_SUMMARY.md` - æœ¬æ–‡æ¡£

---

*å®Œæˆæ—¶é—´: 2026-02-10*
*çŠ¶æ€: æ‰€æœ‰åŠŸèƒ½å·²å®Œæˆå¹¶é›†æˆ âœ…*

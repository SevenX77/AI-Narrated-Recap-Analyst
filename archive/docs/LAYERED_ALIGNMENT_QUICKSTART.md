# 分层对齐方案 - 快速开始指南

**版本**: v3.0  
**日期**: 2026-02-04

---

## 🎯 方案概述

基于你的核心洞察：**男频系统爽剧 ≈ 游戏**

我们设计了全新的**分层对齐模型**，将信息分为四层：

```
Layer 1: 设定层 (World Building)   - 世界观、规则、背景
Layer 2: 系统层 (Game Mechanics)   - 能力体系、系统机制
Layer 3: 道具层 (Items & Equipment) - 道具获得、升级、使用
Layer 4: 情节层 (Plot Events)       - 角色行动、事件发生
```

**核心优势**：
- ✅ 解决"游戏化元素"位置不同的问题
- ✅ 设定类信息语义匹配，位置无关
- ✅ 系统类信息按机制匹配，聚合完整
- ✅ 道具类信息追踪演化链
- ✅ 情节类信息严格时序匹配

---

## 📁 已创建的文件

### 1. 设计文档
```
docs/architecture/LAYERED_ALIGNMENT_DESIGN.md
```
- 完整的设计理念
- 四层模型详细说明
- 匹配算法设计
- 预期效果分析

### 2. 提取Prompt
```
src/prompts/layered_extraction.yaml
```
包含4个提取Prompt：
- `extract_world_building` - 提取设定层
- `extract_game_mechanics` - 提取系统层
- `extract_items` - 提取道具层
- `extract_plot_events` - 提取情节层

### 3. 测试脚本
```
scripts/test_layered_extraction.py
```
用于验证分层提取的可行性

---

## 🚀 快速测试

### Step 1: 运行测试脚本

```bash
cd /Users/sevenx/Documents/coding/AI-Narrated\ Recap\ Analyst
python scripts/test_layered_extraction.py
```

这个脚本会：
1. 从Novel第1章提取四层信息
2. 从Script前2分钟提取四层信息
3. 对比两者的提取结果
4. 保存到 `data/projects/PROJ_002/test_layered_extraction/`

### Step 2: 查看提取结果

测试完成后，查看生成的文件：

```bash
# 查看Script的提取结果
cat data/projects/PROJ_002/test_layered_extraction/script_layers.json

# 查看Novel的提取结果
cat data/projects/PROJ_002/test_layered_extraction/novel_layers.json
```

### Step 3: 分析结果

重点关注：

1. **设定层**：Script和Novel是否提取到相同的世界观设定？
   - 例如："诡异无法被杀死"

2. **系统层**：升级系统的各个要素是否完整提取？
   - 系统名称、机制、借贷规则

3. **道具层**：二八大杠的演化链是否完整？
   - 获得 → 升级 → 三轮车

4. **情节层**：关键情节是否按顺序提取？
   - 广播 → 露营 → 煮泡面 → 触摸毛毯

---

## 📊 预期效果

### 测试数据对比

| 层级 | Script 预期 | Novel 预期 | 匹配难度 |
|------|------------|-----------|---------|
| 设定层 | 5-8项 | 10-15项 | ⭐⭐ 容易（语义匹配）|
| 系统层 | 3-5项 | 5-8项 | ⭐⭐ 容易（机制匹配）|
| 道具层 | 2-3项 | 3-5项 | ⭐⭐⭐ 中等（状态追踪）|
| 情节层 | 8-12项 | 15-20项 | ⭐⭐⭐⭐ 较难（时序匹配）|

### 成功指标

✅ **提取成功**：
- 每层都能成功提取信息
- JSON格式正确
- 内容与原文对应

✅ **信息分层清晰**：
- 设定、系统、道具、情节各归其类
- 没有信息重复或遗漏

✅ **匹配可行**：
- Script和Novel的相同信息能被识别
- 不同层的匹配难度符合预期

---

## 🔍 问题排查

### 问题1：JSON解析失败

**现象**：`❌ JSON解析失败`

**可能原因**：
- LLM返回的JSON格式不正确
- 包含了markdown代码块标记

**解决方案**：
- 检查LLM返回的原始内容
- 调整Prompt，强调返回纯JSON
- 增加JSON格式验证

### 问题2：提取信息过少

**现象**：某层只提取到1-2项

**可能原因**：
- Prompt不够明确
- LLM理解有误
- 文本本身该层信息较少

**解决方案**：
- 查看原文，确认是否确实信息少
- 优化Prompt，提供更多示例
- 调整提取标准

### 问题3：信息分类错误

**现象**：设定类信息被提取到情节层

**可能原因**：
- Prompt区分不够清晰
- LLM对信息类型判断有误

**解决方案**：
- 在Prompt中明确排除规则
- 添加负面示例
- 调整system prompt

---

## 📈 下一步计划

### Phase 1: 验证提取质量（当前阶段）

**目标**：确保四层信息提取正确

**行动**：
1. 运行测试脚本
2. 人工检查提取结果
3. 调优Prompt

**预计时间**：1-2小时

### Phase 2: 实现匹配算法

**目标**：实现四层匹配逻辑

**行动**：
1. 创建 `LayeredMatchingEngine` 类
2. 实现每层的匹配算法
3. 实现综合评分

**预计时间**：3-4小时

### Phase 3: 端到端测试

**目标**：在PROJ_002上完整测试

**行动**：
1. 集成到 Ingestion Workflow
2. 处理完整的Novel和Script
3. 对比v2方案的改进

**预计时间**：2-3小时

### Phase 4: 生产部署

**目标**：替换现有方案

**行动**：
1. 性能优化（并发、缓存）
2. 错误处理和日志
3. 文档更新

**预计时间**：2-3小时

---

## 💡 关键洞察回顾

### 你的核心发现

> "像这种男频系统、穿越等等的爽剧，有点像游戏，各种架空的游戏设定、道具、技能这些信息都是非常关键的，解说稿中这些部分也是关键信息，甚至一开始花大量的时间在交代这部分信息"

### 为什么这个洞察重要

1. **识别了信息类型的差异**
   - 设定类：静态、全局
   - 情节类：动态、时序

2. **发现了Script的叙事策略**
   - 游戏化元素前置（Hook）
   - 吸引观众的核心卖点

3. **指出了匹配失败的根本原因**
   - 传统方案混合处理所有信息
   - 位置不同导致匹配失败

4. **提供了解决方案的方向**
   - 分层处理
   - 按信息类型选择匹配策略

---

## 🎓 适用性分析

### 高度适用（⭐⭐⭐⭐⭐）

- 男频系统流
- 男频玄幻修仙
- 男频游戏异世界
- 男频科幻机甲

**特点**：有明确的体系、道具、技能

### 中度适用（⭐⭐⭐）

- 男频都市异能
- 女频古言宫斗
- 历史架空

**特点**：有规则体系，但"游戏化"程度较弱

### 低度适用（⭐⭐）

- 女频现代言情
- 悬疑推理
- 生活剧

**特点**：几乎无"游戏化"元素，主要靠情节

**解决方案**：调整层级权重，情节层权重提高到50-60%

---

## 📞 需要帮助？

如果测试过程中遇到问题：

1. **查看日志**：测试脚本会输出详细日志
2. **检查文件**：查看 `test_layered_extraction/` 目录下的结果
3. **参考文档**：阅读 `LAYERED_ALIGNMENT_DESIGN.md`
4. **联系开发者**：描述问题和日志

---

## ✅ 检查清单

测试前确认：

- [ ] 已安装所有依赖（deepseek SDK）
- [ ] API密钥配置正确
- [ ] 测试数据文件存在（novel.txt, ep01.srt）
- [ ] 有足够的API额度

测试后检查：

- [ ] 四层信息都成功提取
- [ ] JSON格式正确
- [ ] 提取内容符合预期
- [ ] Script和Novel的相同信息能对应上

---

**祝测试顺利！🚀**

如果提取效果好，我们就可以进入Phase 2，实现匹配算法了。
